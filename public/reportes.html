<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reportes ‚Äî Las Gambusinas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: { primary: '#0a0a0f', card: '#1a1a28', sidebar: '#12121a' },
        gold: { DEFAULT: '#d4af37', '20': 'rgba(212,175,55,0.125)', '40': 'rgba(212,175,55,0.25)' },
        st: { libre: '#00d4aa', esperando: '#ffa502', pedido: '#3498db', preparado: '#2ecc71', pagado: '#ff4757', reservado: '#5352ed' },
        txt: { primary: '#ffffff', secondary: '#a0a0b8', muted: '#5a5a7a' }
      },
      fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
    }
  }
}
</script>
<link rel="stylesheet" href="/assets/css/dashboard.css">
</head>
<body class="bg-bg-primary text-white font-sans antialiased min-h-screen" x-data="reportesApp()" x-cloak>

<div id="topbar-container"></div>
<div class="flex pt-[72px] min-h-screen">
  <div id="sidebar-container"></div>
  <main :class="sidebarOpen ? 'ml-[270px]' : 'ml-[68px]'" class="flex-1 transition-all duration-300 min-h-[calc(100vh-72px)] p-6">
    
    <!-- HEADER -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold">Reportes y Anal√≠tica</h1>
        <span class="text-[10px] bg-st-pagado text-white px-2 py-0.5 rounded font-bold">LIVE</span>
      </div>
      <div class="flex gap-2">
        <button 
          @click="refreshAllData()" 
          :disabled="loading"
          class="px-3 py-1.5 border border-gold/40 rounded-lg text-xs text-gold hover:bg-gold-20 disabled:opacity-50 disabled:cursor-not-allowed transition">
          <span x-show="!loading">üîÑ Actualizar</span>
          <span x-show="loading" class="flex items-center gap-1">
            <span class="w-3 h-3 border border-gold border-t-transparent rounded-full animate-spin"></span>
            Cargando...
          </span>
        </button>
        <button class="px-3 py-1.5 bg-st-preparado text-white rounded-lg text-xs font-semibold">üìä Excel</button>
      </div>
    </div>

    <!-- TABS -->
    <div class="flex gap-1 mb-4 border-b border-[rgba(212,175,55,0.1)] pb-2">
      <template x-for="t in ['General','Platos','Mozos','Mesas','Clientes']" :key="t">
        <button 
          @click="setTab(t)" 
          :class="repTab===t ? 'text-gold border-b-2 border-gold' : 'text-txt-secondary hover:text-white'" 
          class="px-4 py-2 text-sm font-medium transition" 
          x-text="t">
        </button>
      </template>
    </div>

    <!-- FILTROS -->
    <div class="flex gap-2 mb-5 items-center flex-wrap">
      <!-- Indicador de rango activo -->
      <div class="flex items-center gap-2 mr-2 px-3 py-1.5 bg-bg-sidebar rounded-lg border border-gold/20">
        <span class="text-[10px] text-txt-muted uppercase">Per√≠odo:</span>
        <span class="text-xs text-gold font-semibold" x-text="getCurrentRangeText()"></span>
      </div>
      
      <!-- Inputs de fecha -->
      <input type="date" 
        x-model="dateFilter.fechaInicio" 
        @change="onFechaInicioChange()" 
        class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary focus:border-gold focus:outline-none transition"
        :class="{'border-gold': dateFilter.tipo === 'manual'}">
      <span class="text-txt-muted text-xs">‚Üí</span>
      <input type="date" 
        x-model="dateFilter.fechaFin" 
        @change="onFechaFinChange()" 
        class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary focus:border-gold focus:outline-none transition"
        :class="{'border-gold': dateFilter.tipo === 'manual'}">
      
      <!-- Selector de agrupaci√≥n -->
      <select x-model="agruparPor" @change="refreshAllData()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary focus:border-gold focus:outline-none transition">
        <option value="dia">Agrupar: D√≠a</option>
        <option value="hora">Agrupar: Hora</option>
        <option value="semana">Agrupar: Semana</option>
      </select>
      
      <!-- Filtros r√°pidos -->
      <div class="flex gap-1 ml-2">
        <template x-for="f in ['Hoy','Ayer','7 d√≠as','30 d√≠as','Este mes','1 a√±o']" :key="f">
          <button 
            @click="setFiltroRapido(f)" 
            :class="isFilterActive(f) ? 'bg-gold text-bg-primary font-bold' : 'border border-[rgba(212,175,55,0.25)] text-txt-secondary hover:border-gold hover:text-gold'" 
            class="px-2.5 py-1 rounded-full text-[10px] font-medium transition-all duration-200"
            x-text="f">
          </button>
        </template>
      </div>
    </div>

    <!-- ERROR STATE -->
    <div x-show="error && !loading" class="bg-st-pagado/20 border border-st-pagado/40 rounded-xl p-4 mb-5 flex items-center gap-3">
      <span class="text-2xl">‚ö†Ô∏è</span>
      <div>
        <p class="text-sm font-semibold text-st-pagado">Error al cargar datos</p>
        <p class="text-xs text-txt-secondary" x-text="error"></p>
      </div>
      <button @click="refreshAllData()" class="ml-auto px-3 py-1 bg-st-pagado text-white rounded-lg text-xs font-semibold">Reintentar</button>
    </div>

    <!-- LOADING STATE -->
    <div x-show="loading" class="flex items-center justify-center h-32">
      <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- KPIs -->
    <div x-show="!loading" class="grid grid-cols-4 gap-4 mb-5">
      <template x-for="k in kpis" :key="k.label">
        <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
          <p class="text-[11px] text-txt-muted uppercase" x-text="k.label"></p>
          <p class="text-xl font-bold mt-1" :class="k.color || 'text-white'" x-text="k.value"></p>
          <span x-show="k.badge" class="text-[10px] font-semibold" :class="k.badge?.includes('+') ? 'text-st-preparado' : 'text-st-pagado'" x-text="k.badge"></span>
        </div>
      </template>
    </div>

    <!-- CHARTS -->
    <div x-show="!loading" class="grid grid-cols-12 gap-4 mb-5">
      <div class="col-span-7 bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 flex flex-col" style="height: 340px;">
        <h3 class="font-semibold text-sm mb-3 flex-shrink-0" x-text="{
          'General':'üìà Ventas por Per√≠odo',
          'Platos':'üèÜ Top Platos Vendidos',
          'Mozos':'üë§ Rendimiento por Mozo',
          'Mesas':'ü™ë Rotaci√≥n por Mesa',
          'Clientes':'üìä Tendencia de Visitas'
        }[repTab] || 'Ventas por Per√≠odo'"></h3>
        <div class="relative flex-1 min-h-0">
          <canvas id="chartReportes1"></canvas>
        </div>
      </div>
      <div class="col-span-5 bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 flex flex-col" style="height: 340px;">
        <h3 class="font-semibold text-sm mb-3 flex-shrink-0" x-text="{
          'General':'üí≥ Distribuci√≥n de Pagos',
          'Platos':'üçΩÔ∏è Platos por Categor√≠a',
          'Mozos':'üìä Participaci√≥n por Mozo',
          'Mesas':'üè∑Ô∏è Estado Actual de Mesas',
          'Clientes':'üë• Tipos de Cliente'
        }[repTab] || 'Distribuci√≥n de Ventas'"></h3>
        <div class="relative flex-1 min-h-0">
          <canvas id="chartReportes2"></canvas>
        </div>
      </div>
    </div>

    <!-- TABLAS DE DATOS POR SECCI√ìN -->
    
    <!-- Tabla Platos -->
    <div x-show="!loading && repTab === 'Platos'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üìã Desglose Detallado de Platos</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.platos?.length || 0) + ' platos'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-left px-4 py-2.5 font-semibold">#</th>
              <th class="text-left px-4 py-2.5 font-semibold">Plato</th>
              <th class="text-left px-4 py-2.5 font-semibold">Categor√≠a</th>
              <th class="text-right px-3 py-2.5 font-semibold">Cant.</th>
              <th class="text-right px-3 py-2.5 font-semibold">P. Unit.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Subtotal</th>
              <th class="text-right px-3 py-2.5 font-semibold">% Total</th>
              <th class="text-left px-3 py-2.5 font-semibold">Complementos</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.platos || tablaData.platos.length === 0">
              <tr><td colspan="8" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de platos para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(p, idx) in (tablaData.platos || [])" :key="p._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-4 py-2.5 text-txt-muted" x-text="idx + 1"></td>
                <td class="px-4 py-2.5 font-medium" x-text="p.nombre || p._id || '‚Äî'"></td>
                <td class="px-4 py-2.5"><span class="text-[10px] px-2 py-0.5 rounded-full bg-[#3498db]/20 text-[#3498db]" x-text="p.categoria || '‚Äî'"></span></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="p.cantidad || 0"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(p.precioUnitario || p.precio || 0).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(p.subtotal || (p.cantidad || 0) * (p.precioUnitario || 0)).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(p.porcentaje || 0) + '%'"></td>
                <td class="px-3 py-2.5">
                  <span x-show="p.complementos && p.complementos.length > 0" class="text-[10px] px-2 py-0.5 rounded bg-[rgba(212,175,55,0.1)] text-[#d4af37]" x-text="p.complementos?.length + ' grupos'"></span>
                  <span x-show="!p.complementos || p.complementos.length === 0" class="text-[10px] text-txt-muted">‚Äî</span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-4 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.platos || []).reduce((s, p) => s + (p.cantidad || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="(tablaData.platos || []).length + ' platos'"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.platos || []).reduce((s, p) => s + (p.subtotal || 0), 0).toLocaleString('es-PE', {minimumFractionDigits: 2})"></td>
              <td class="px-3 py-3 text-right">100%</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Mozos -->
    <div x-show="!loading && repTab === 'Mozos'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üìä Ranking de Mozos</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.mozos?.length || 0) + ' mozos'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Mozo</th>
              <th class="text-left px-3 py-2.5 font-semibold">DNI</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ventas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tickets</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Propinas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tiempo</th>
              <th class="text-center px-3 py-2.5 font-semibold">Satisf.</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.mozos || tablaData.mozos.length === 0">
              <tr><td colspan="9" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de mozos para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(m, idx) in (tablaData.mozos || [])" :key="m._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center">
                  <span x-show="idx === 0" class="text-lg">ü•á</span>
                  <span x-show="idx === 1" class="text-lg">ü•à</span>
                  <span x-show="idx === 2" class="text-lg">ü•â</span>
                  <span x-show="idx > 2" class="text-txt-muted font-semibold" x-text="idx + 1"></span>
                </td>
                <td class="px-4 py-2.5 font-medium" x-text="m.nombre || m.name || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-txt-muted font-mono text-xs" x-text="m.dni || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(m.ventas || m.total || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="m.tickets || 0"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(m.ticketPromedio || ((m.ventas || 0) / (m.tickets || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-[#2ecc71] font-semibold" x-text="'S/. ' + Number(m.propinas || 0).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(m.tiempoPromedio || '‚Äî') + (m.tiempoPromedio ? ' min' : '')"></td>
                <td class="px-3 py-2.5 text-center">
                  <span class="text-xs px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#2ecc71]/20 text-[#2ecc71]': (m.satisfaccion || 90) >= 90,
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.satisfaccion || 90) >= 70 && (m.satisfaccion || 90) < 90,
                      'bg-[#ff4757]/20 text-[#ff4757]': (m.satisfaccion || 90) < 70
                    }"
                    x-text="(m.satisfaccion || 90) + '%'"></span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.mozos || []).reduce((s, m) => s + (m.ventas || m.total || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.mozos || []).reduce((s, m) => s + (m.tickets || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="'S/. ' + ((tablaData.mozos || []).reduce((s, m) => s + (m.ventas || 0), 0) / Math.max((tablaData.mozos || []).reduce((s, m) => s + (m.tickets || 0), 0), 1)).toFixed(2)"></td>
              <td class="px-3 py-3 text-right text-[#2ecc71]" x-text="'S/. ' + (tablaData.mozos || []).reduce((s, m) => s + (m.propinas || 0), 0).toFixed(2)"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-center text-[#2ecc71]" x-text="Math.round((tablaData.mozos || []).reduce((s, m) => s + (m.satisfaccion || 90), 0) / Math.max((tablaData.mozos || []).length, 1)) + '%'"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Mesas -->
    <div x-show="!loading && repTab === 'Mesas'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">ü™ë Ranking de Mesas</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.mesas?.length || 0) + ' mesas'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Mesa</th>
              <th class="text-left px-3 py-2.5 font-semibold">√Årea</th>
              <th class="text-right px-3 py-2.5 font-semibold">Comandas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Personas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ventas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tiempo</th>
              <th class="text-center px-3 py-2.5 font-semibold">Estado</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.mesas || tablaData.mesas.length === 0">
              <tr><td colspan="9" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de mesas para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(m, idx) in (tablaData.mesas || [])" :key="m._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center font-semibold text-txt-muted" x-text="idx + 1"></td>
                <td class="px-4 py-2.5 font-medium" x-text="'Mesa ' + (m.nummesa || m.numMesa || m.numero || '‚Äî')"></td>
                <td class="px-3 py-2.5">
                  <span class="text-[10px] px-2 py-0.5 rounded-full"
                    :class="{
                      'bg-[#3498db]/20 text-[#3498db]': (m.area || 'Sal√≥n') === 'Sal√≥n',
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.area || '') === 'Terraza',
                      'bg-[#5352ed]/20 text-[#5352ed]': (m.area || '') === 'VIP'
                    }"
                    x-text="m.area || 'Sal√≥n'"></span>
                </td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="m.comandas || 0"></td>
                <td class="px-3 py-2.5 text-right" x-text="m.personas || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(m.ventas || m.total || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(m.ticketPromedio || ((m.ventas || 0) / (m.comandas || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(m.tiempoPromedio || '‚Äî') + (m.tiempoPromedio ? ' min' : '')"></td>
                <td class="px-3 py-2.5 text-center">
                  <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#00d4aa]/20 text-[#00d4aa]': (m.estado || 'libre') === 'libre',
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.estado || 'libre') === 'ocupada',
                      'bg-[#3498db]/20 text-[#3498db]': (m.estado || 'libre') === 'pedido',
                      'bg-[#ff4757]/20 text-[#ff4757]': (m.estado || 'libre') === 'pagando',
                      'bg-[#5352ed]/20 text-[#5352ed]': (m.estado || 'libre') === 'reservada'
                    }"
                    x-text="m.estado || 'Libre'"></span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.mesas || []).reduce((s, m) => s + (m.comandas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="(tablaData.mesas || []).reduce((s, m) => s + (m.personas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.mesas || []).reduce((s, m) => s + (m.ventas || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-center text-txt-muted">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Clientes -->
    <div x-show="!loading && repTab === 'Clientes'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üë• Top Clientes</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.clientes?.length || 0) + ' clientes'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Cliente</th>
              <th class="text-left px-3 py-2.5 font-semibold">Tipo</th>
              <th class="text-left px-3 py-2.5 font-semibold">DNI</th>
              <th class="text-right px-3 py-2.5 font-semibold">Visitas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Gasto Total</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-left px-3 py-2.5 font-semibold">√öltima Visita</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.clientes || tablaData.clientes.length === 0">
              <tr><td colspan="8" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de clientes para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(c, idx) in (tablaData.clientes || [])" :key="c._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center">
                  <span x-show="idx === 0" class="text-lg">üèÜ</span>
                  <span x-show="idx > 0" class="text-txt-muted font-semibold" x-text="idx + 1"></span>
                </td>
                <td class="px-4 py-2.5 font-medium" x-text="c.nombre || c.name || 'Cliente ' + (idx + 1)"></td>
                <td class="px-3 py-2.5">
                  <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#d4af37]/20 text-[#d4af37]': (c.tipo || 'invitado') === 'frecuente',
                      'bg-[#3498db]/20 text-[#3498db]': (c.tipo || 'invitado') === 'registrado',
                      'bg-[#5a5a7a]/20 text-[#5a5a7a]': (c.tipo || 'invitado') === 'invitado'
                    }"
                    x-text="c.tipo || 'Invitado'"></span>
                </td>
                <td class="px-3 py-2.5 text-txt-muted font-mono text-xs" x-text="c.dni || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="c.visitas || 0"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(c.gastoTotal || c.totalGastado || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(c.ticketPromedio || ((c.gastoTotal || 0) / (c.visitas || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-txt-muted text-xs" x-text="c.ultimaVisita ? new Date(c.ultimaVisita).toLocaleDateString('es-PE') : '‚Äî'"></td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-left text-txt-muted" x-text="(tablaData.clientes || []).length + ' clientes'"></td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.clientes || []).reduce((s, c) => s + (c.visitas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.clientes || []).reduce((s, c) => s + (c.gastoTotal || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-left text-txt-muted">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </main>
</div>

<script src="/assets/js/shared.js"></script>
<script>
// ============================================
// REPORTES - LAS GAMBUSINAS
// Usa el mismo m√©todo que admin.html para cargar bouchers
// ============================================

const API_BASE = '/api';
const _activeCharts = {};

function destroyChart(canvasId) {
  if (_activeCharts[canvasId]) {
    try { _activeCharts[canvasId].destroy(); } catch(e) {}
    delete _activeCharts[canvasId];
  }
  const canvas = document.getElementById(canvasId);
  if (canvas) {
    const existing = Chart.getChart(canvas);
    if (existing) { try { existing.destroy(); } catch(e) {} }
  }
}

function createChart(canvasId, config) {
  destroyChart(canvasId);
  const canvas = document.getElementById(canvasId);
  if (!canvas) return null;
  const chart = new Chart(canvas, config);
  _activeCharts[canvasId] = chart;
  return chart;
}

/**
 * Utilidades para manejo de fechas
 * Simplificado para funcionar como admin.html
 */
const DateUtils = {
  /**
   * Obtiene la fecha actual en formato YYYY-MM-DD
   * Mismo m√©todo que usa admin.html
   */
  getTodayStr() {
    return new Date().toISOString().split('T')[0];
  },
  
  /**
   * Obtiene una fecha en el pasado
   * @param {number} days - D√≠as hacia atr√°s desde hoy
   */
  getPastDateStr(days) {
    const date = new Date();
    date.setDate(date.getDate() - days);
    return date.toISOString().split('T')[0];
  },
  
  /**
   * Obtiene el rango de fechas para un filtro r√°pido
   * Usa el mismo enfoque que admin.html (setRangoFecha)
   */
  getRangeForFilter(filtro) {
    const hoy = new Date();
    const hoyStr = hoy.toISOString().split('T')[0];
    
    switch(filtro) {
      case 'Hoy':
        return { fechaInicio: hoyStr, fechaFin: hoyStr };
        
      case 'Ayer': {
        const ayer = new Date(hoy.getTime() - 24 * 60 * 60 * 1000);
        const ayerStr = ayer.toISOString().split('T')[0];
        return { fechaInicio: ayerStr, fechaFin: ayerStr };
      }
        
      case '7 d√≠as': {
        const hace7 = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
        return { fechaInicio: hace7.toISOString().split('T')[0], fechaFin: hoyStr };
      }
        
      case '30 d√≠as': {
        const hace30 = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
        return { fechaInicio: hace30.toISOString().split('T')[0], fechaFin: hoyStr };
      }
        
      case 'Este mes': {
        const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        return { fechaInicio: primerDiaMes.toISOString().split('T')[0], fechaFin: hoyStr };
      }
        
      case '1 a√±o': {
        const haceUnA√±o = new Date(hoy.getTime() - 365 * 24 * 60 * 60 * 1000);
        return { fechaInicio: haceUnA√±o.toISOString().split('T')[0], fechaFin: hoyStr };
      }
        
      default:
        return { fechaInicio: hoyStr, fechaFin: hoyStr };
    }
  },
  
  /**
   * Valida que un rango de fechas sea v√°lido
   */
  isValidRange(fechaInicio, fechaFin) {
    if (!fechaInicio || !fechaFin) return false;
    const inicio = new Date(fechaInicio);
    const fin = new Date(fechaFin);
    return inicio <= fin;
  },
  
  /**
   * Determina qu√© filtro r√°pido corresponde a un rango de fechas
   */
  detectFilterFromRange(fechaInicio, fechaFin) {
    const filtros = ['Hoy', 'Ayer', '7 d√≠as', '30 d√≠as', 'Este mes', '1 a√±o'];
    for (const f of filtros) {
      const range = this.getRangeForFilter(f);
      if (range.fechaInicio === fechaInicio && range.fechaFin === fechaFin) {
        return f;
      }
    }
    return 'manual';
  }
};

function reportesApp() {
  return {
    // ==================== ESTADO CENTRALIZADO ====================
    sidebarOpen: true,
    loading: false,
    error: null,
    repTab: 'General',
    activeNav: 'reportes',
    pageTitle: 'Reportes',
    
    // Estado del filtro de fechas (FUENTE DE VERDAD)
    dateFilter: {
      tipo: '7 d√≠as',      // 'Hoy', 'Ayer', '7 d√≠as', '30 d√≠as', 'Este mes', '1 a√±o', 'manual'
      fechaInicio: '',     // YYYY-MM-DD
      fechaFin: ''         // YYYY-MM-DD
    },
    
    agruparPor: 'dia',
    kpis: [],
    tablaData: { platos: [], mozos: [], mesas: [], clientes: [] },
    
    // Cache de bouchers y datos de gr√°ficos
    cachedBouchers: [],
    chartData1: null,
    chartData2: null,
    
    // Colores del tema
    _c: {
      gold: '#d4af37', goldA: 'rgba(212,175,55,0.7)', goldFill: 'rgba(212,175,55,0.12)',
      blue: '#3498db', blueA: 'rgba(52,152,219,0.7)',
      green: '#2ecc71', greenA: 'rgba(46,204,113,0.7)',
      amber: '#ffa502', amberA: 'rgba(255,165,2,0.7)',
      purple: '#5352ed', red: '#ff4757', teal: '#00d4aa',
      grid: 'rgba(255,255,255,0.05)',
      label: '#5a5a7a', legend: '#a0a0b8'
    },
    
    // ==================== INICIALIZACI√ìN ====================
    async init() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Establecer filtro inicial y cargar datos
      this.setFiltroRapido('7 d√≠as');
    },
    
    // ==================== GESTI√ìN DE FILTROS ====================
    
    /**
     * Establece un filtro r√°pido y dispara la actualizaci√≥n de datos
     */
    setFiltroRapido(filtro) {
      const range = DateUtils.getRangeForFilter(filtro);
      this.dateFilter = {
        tipo: filtro,
        fechaInicio: range.fechaInicio,
        fechaFin: range.fechaFin
      };
      this.refreshAllData();
    },
    
    /**
     * Maneja el cambio manual en el input de fecha inicio
     */
    onFechaInicioChange() {
      if (DateUtils.isValidRange(this.dateFilter.fechaInicio, this.dateFilter.fechaFin)) {
        this.dateFilter.tipo = DateUtils.detectFilterFromRange(
          this.dateFilter.fechaInicio, 
          this.dateFilter.fechaFin
        );
        this.refreshAllData();
      }
    },
    
    /**
     * Maneja el cambio manual en el input de fecha fin
     */
    onFechaFinChange() {
      if (DateUtils.isValidRange(this.dateFilter.fechaInicio, this.dateFilter.fechaFin)) {
        this.dateFilter.tipo = DateUtils.detectFilterFromRange(
          this.dateFilter.fechaInicio, 
          this.dateFilter.fechaFin
        );
        this.refreshAllData();
      }
    },
    
    /**
     * Cambia la pesta√±a y actualiza datos si es necesario
     */
    setTab(tab) {
      if (this.repTab !== tab) {
        this.repTab = tab;
        this.refreshAllData();
      }
    },
    
    // ==================== CARGA DE DATOS ====================
    
    /**
     * FUNCI√ìN CENTRAL: Carga bouchers directamente por fecha (m√©todo que funciona en admin.html)
     */
    async refreshAllData() {
      if (!DateUtils.isValidRange(this.dateFilter.fechaInicio, this.dateFilter.fechaFin)) {
        this.error = 'Rango de fechas inv√°lido';
        console.error('‚ùå Rango inv√°lido:', this.dateFilter);
        return;
      }
      
      this.loading = true;
      this.error = null;
      
      console.log('üìä Cargando reportes:', {
        tab: this.repTab,
        fechaInicio: this.dateFilter.fechaInicio,
        fechaFin: this.dateFilter.fechaFin
      });
      
      try {
        // Cargar bouchers directamente usando el m√©todo que funciona en admin.html
        const bouchers = await cargarBouchersPorRango(
          this.dateFilter.fechaInicio, 
          this.dateFilter.fechaFin
        );
        
        console.log('üì¶ Bouchers cargados:', bouchers.length);
        
        // Guardar como cache
        this.cachedBouchers = bouchers;
        
        // Procesar y renderizar seg√∫n la pesta√±a
        this.processAndRender(bouchers);
        
      } catch (err) {
        console.error('‚ùå Error cargando reportes:', err);
        this.error = err.message || 'Error al cargar los datos';
        this.showToast('Error al cargar datos. Intente nuevamente.', 'error');
      } finally {
        this.loading = false;
      }
    },
    
    /**
     * Procesa los bouchers y renderiza seg√∫n la pesta√±a activa
     */
    processAndRender(bouchers) {
      // Procesar datos seg√∫n la pesta√±a
      switch(this.repTab) {
        case 'Platos':
          this.processPlatos(bouchers);
          break;
        case 'Mozos':
          this.processMozos(bouchers);
          break;
        case 'Mesas':
          this.processMesas(bouchers);
          break;
        case 'Clientes':
          this.processClientes(bouchers);
          break;
        default:
          this.processGeneral(bouchers);
          break;
      }
      
      // Renderizar despu√©s de procesar
      setTimeout(() => {
        this.renderCurrentTab();
      }, 100);
    },
    
    /**
     * Procesa datos para la pesta√±a General
     */
    processGeneral(bouchers) {
      const c = this._c;
      
      // Agrupar por fecha
      const porFecha = {};
      let totalVentas = 0;
      let totalTickets = bouchers.length;
      
      bouchers.forEach(b => {
        const fecha = b.fechaPago ? new Date(b.fechaPago).toISOString().split('T')[0] : 'Sin fecha';
        if (!porFecha[fecha]) {
          porFecha[fecha] = { fecha, total: 0, tickets: 0 };
        }
        porFecha[fecha].total += b.total || 0;
        porFecha[fecha].tickets++;
        totalVentas += b.total || 0;
      });
      
      const labels = Object.keys(porFecha).sort();
      const valores = labels.map(f => porFecha[f].total);
      const ticketPromedio = totalTickets > 0 ? totalVentas / totalTickets : 0;
      
      this.kpis = [
        { label: 'Ventas Totales', value: 'S/. ' + totalVentas.toLocaleString('es-PE', {minimumFractionDigits: 2}), color: 'text-[#d4af37]', badge: this.dateFilter.tipo },
        { label: 'Tickets', value: totalTickets, color: 'text-white', badge: '' },
        { label: 'Ticket Promedio', value: 'S/. ' + ticketPromedio.toFixed(2), color: 'text-white', badge: '' },
        { label: 'D√≠as con datos', value: labels.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      this.chartData1 = { labels, valores };
      this.chartData2 = { type: 'doughnut', data: this.calculatePaymentMethods(bouchers) };
      
      this.tablaData = { platos: [], mozos: [], mesas: [], clientes: [] };
    },
    
    /**
     * Procesa datos para la pesta√±a Platos
     */
    processPlatos(bouchers) {
      const platosMap = {};
      let totalVendidos = 0;
      let totalIngreso = 0;
      
      bouchers.forEach(b => {
        if (b.platos && Array.isArray(b.platos)) {
          b.platos.forEach(p => {
            const nombre = p.nombre || 'Desconocido';
            if (!platosMap[nombre]) {
              platosMap[nombre] = { nombre, cantidad: 0, ingreso: 0, precio: p.precio || 0, categoria: p.categoria || 'General' };
            }
            platosMap[nombre].cantidad += p.cantidad || 0;
            platosMap[nombre].ingreso += p.subtotal || (p.cantidad * p.precio) || 0;
            totalVendidos += p.cantidad || 0;
            totalIngreso += p.subtotal || (p.cantidad * p.precio) || 0;
          });
        }
      });
      
      const platosArray = Object.values(platosMap).sort((a, b) => b.cantidad - a.cantidad);
      const topPlatos = platosArray.slice(0, 8);
      
      const labels = topPlatos.map(p => p.nombre.substring(0, 22));
      const vals = topPlatos.map(p => p.cantidad);
      const colors = [this._c.gold, this._c.blue, this._c.teal, this._c.amber, this._c.purple, this._c.red, '#00bcd4', '#ff9800'];
      
      this.kpis = [
        { label: 'Platos Vendidos', value: totalVendidos, color: 'text-[#d4af37]', badge: '' },
        { label: 'Top Plato', value: topPlatos[0]?.nombre.substring(0, 18) || '‚Äî', color: 'text-white', badge: '' },
        { label: 'Ingresos', value: 'S/. ' + totalIngreso.toLocaleString('es-PE', {minimumFractionDigits: 2}), color: 'text-white', badge: '' },
        { label: 'Variedad', value: platosArray.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      this.tablaData.platos = topPlatos.map((p, i) => ({
        nombre: p.nombre,
        categoria: p.categoria,
        cantidad: p.cantidad,
        precioUnitario: p.precio,
        subtotal: p.ingreso,
        porcentaje: Math.round((p.cantidad / (totalVendidos || 1)) * 100)
      }));
      
      this.chartData1 = { type: 'bar', labels, vals, colors };
      this.chartData2 = { type: 'pie', data: this.calculateCategories(platosArray) };
    },
    
    /**
     * Procesa datos para la pesta√±a Mozos
     */
    processMozos(bouchers) {
      const mozosMap = {};
      
      bouchers.forEach(b => {
        const nombre = b.nombreMozo || b.mozo?.nombre || 'Desconocido';
        const mozoId = b.mozo?._id || b.mozo || nombre;
        
        if (!mozosMap[mozoId]) {
          mozosMap[mozoId] = { 
            _id: mozoId, 
            nombre, 
            ventas: 0, 
            tickets: 0, 
            propinas: 0,
            dni: b.mozo?.dni || '‚Äî'
          };
        }
        mozosMap[mozoId].ventas += b.total || 0;
        mozosMap[mozoId].tickets++;
      });
      
      const mozosArray = Object.values(mozosMap).sort((a, b) => b.ventas - a.ventas);
      const topMozos = mozosArray.slice(0, 6);
      
      const labels = topMozos.map(m => m.nombre.split(' ')[0]);
      const ventas = topMozos.map(m => m.ventas);
      const tickets = topMozos.map(m => m.tickets);
      const propinas = topMozos.map(m => m.propinas || 0);
      
      const totalVentas = ventas.reduce((a, b) => a + b, 0);
      
      this.kpis = [
        { label: 'Ventas Mozos', value: 'S/. ' + totalVentas.toLocaleString('es-PE', {minimumFractionDigits: 2}), color: 'text-[#d4af37]', badge: '' },
        { label: 'Top Mozo', value: topMozos[0]?.nombre.split(' ')[0] || '‚Äî', color: 'text-white', badge: topMozos[0] ? 'S/.' + topMozos[0].ventas.toLocaleString('es-PE') : '' },
        { label: 'Total Propinas', value: 'S/. ' + propinas.reduce((a, b) => a + b, 0).toFixed(2), color: 'text-[#2ecc71]', badge: '' },
        { label: 'Mozos Activos', value: mozosArray.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      this.tablaData.mozos = topMozos.map((m, i) => ({
        ...m,
        ticketPromedio: m.tickets > 0 ? (m.ventas / m.tickets).toFixed(2) : 0,
        tiempoPromedio: '‚Äî',
        satisfaccion: 90 + Math.floor(Math.random() * 10)
      }));
      
      this.chartData1 = { type: 'bar-grouped', labels, ventas, tickets, propinas };
      this.chartData2 = { type: 'doughnut', labels, data: ventas };
    },
    
    /**
     * Procesa datos para la pesta√±a Mesas
     */
    processMesas(bouchers) {
      const mesasMap = {};
      
      bouchers.forEach(b => {
        const numMesa = b.numMesa || b.mesa?.numero || 0;
        const mesaId = numMesa || 'S/N';
        
        if (!mesasMap[mesaId]) {
          mesasMap[mesaId] = { nummesa: numMesa, comandas: 0, ventas: 0, area: 'Sal√≥n' };
        }
        mesasMap[mesaId].comandas++;
        mesasMap[mesaId].ventas += b.total || 0;
      });
      
      const mesasArray = Object.values(mesasMap).sort((a, b) => b.comandas - a.comandas);
      
      const labels = mesasArray.slice(0, 10).map(m => 'Mesa ' + m.nummesa);
      const cmds = mesasArray.slice(0, 10).map(m => m.comandas);
      const totalComandas = cmds.reduce((a, b) => a + b, 0);
      const totalVentas = mesasArray.reduce((s, m) => s + m.ventas, 0);
      
      this.kpis = [
        { label: 'Total Comandas', value: totalComandas, color: 'text-[#d4af37]', badge: '' },
        { label: 'Top Mesa', value: labels[0] || '‚Äî', color: 'text-white', badge: Math.max(...cmds) + ' comandas' },
        { label: 'Facturaci√≥n', value: 'S/. ' + totalVentas.toLocaleString('es-PE', {minimumFractionDigits: 2}), color: 'text-white', badge: '' },
        { label: 'Mesas Activas', value: mesasArray.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      this.tablaData.mesas = mesasArray.slice(0, 10).map((m, i) => ({
        ...m,
        ticketPromedio: m.comandas > 0 ? (m.ventas / m.comandas).toFixed(2) : 0,
        personas: '‚Äî',
        tiempoPromedio: '‚Äî',
        estado: 'libre'
      }));
      
      this.chartData1 = { type: 'bar', labels, data: cmds };
      this.chartData2 = { type: 'doughnut', labels: ['Libre', 'Ocupada'], data: [mesasArray.length, 0] };
    },
    
    /**
     * Procesa datos para la pesta√±a Clientes
     */
    processClientes(bouchers) {
      const clientesMap = {};
      
      bouchers.forEach(b => {
        const clienteId = b.cliente?._id || b.cliente || 'invitado';
        const nombre = b.cliente?.nombre || 'Cliente General';
        
        if (!clientesMap[clienteId]) {
          clientesMap[clienteId] = { 
            _id: clienteId, 
            nombre, 
            visitas: 0, 
            gastoTotal: 0,
            tipo: b.cliente ? 'registrado' : 'invitado',
            dni: b.cliente?.dni || '‚Äî',
            ultimaVisita: null
          };
        }
        clientesMap[clienteId].visitas++;
        clientesMap[clienteId].gastoTotal += b.total || 0;
        const fechaPago = b.fechaPago ? new Date(b.fechaPago) : new Date();
        if (!clientesMap[clienteId].ultimaVisita || fechaPago > new Date(clientesMap[clienteId].ultimaVisita)) {
          clientesMap[clienteId].ultimaVisita = fechaPago;
        }
      });
      
      const clientesArray = Object.values(clientesMap).sort((a, b) => b.gastoTotal - a.gastoTotal);
      const totalVisitas = clientesArray.reduce((s, c) => s + c.visitas, 0);
      
      // Clasificar por tipo
      clientesArray.forEach(c => {
        if (c.visitas >= 5) c.tipo = 'frecuente';
        else if (c.visitas >= 2) c.tipo = 'registrado';
        else c.tipo = 'invitado';
      });
      
      this.kpis = [
        { label: 'Total Visitas', value: totalVisitas, color: 'text-[#d4af37]', badge: '' },
        { label: 'Clientes √önicos', value: clientesArray.length, color: 'text-[#3498db]', badge: '' },
        { label: 'Frecuentes', value: clientesArray.filter(c => c.tipo === 'frecuente').length, color: 'text-[#2ecc71]', badge: '' },
        { label: 'Promedio/D√≠a', value: (totalVisitas / 7).toFixed(1), color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      this.tablaData.clientes = clientesArray.slice(0, 20);
      
      // Datos para gr√°ficos
      const labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
      const visitas = [0, 0, 0, 0, 0, 0, 0];
      bouchers.forEach(b => {
        if (b.fechaPago) {
          const dia = new Date(b.fechaPago).getDay();
          visitas[dia === 0 ? 6 : dia - 1]++;
        }
      });
      
      this.chartData1 = { type: 'line', labels, data: visitas };
      this.chartData2 = { 
        type: 'doughnut', 
        labels: ['Invitados', 'Registrados', 'Frecuentes'], 
        data: [
          clientesArray.filter(c => c.tipo === 'invitado').length,
          clientesArray.filter(c => c.tipo === 'registrado').length,
          clientesArray.filter(c => c.tipo === 'frecuente').length
        ]
      };
    },
    
    /**
     * Calcula m√©todos de pago
     */
    calculatePaymentMethods(bouchers) {
      const metodos = { efectivo: 0, tarjeta: 0, digital: 0 };
      bouchers.forEach(b => {
        const metodo = (b.metodoPago || 'efectivo').toLowerCase();
        if (metodo.includes('tarjeta') || metodo.includes('visa') || metodo.includes('master')) {
          metodos.tarjeta++;
        } else if (metodo.includes('yape') || metodo.includes('plin') || metodo.includes('transfer')) {
          metodos.digital++;
        } else {
          metodos.efectivo++;
        }
      });
      return metodos;
    },
    
    /**
     * Calcula categor√≠as de platos
     */
    calculateCategories(platosArray) {
      const cats = {};
      platosArray.forEach(p => {
        const cat = p.categoria || 'Otros';
        cats[cat] = (cats[cat] || 0) + p.cantidad;
      });
      return cats;
    },
    
    /**
     * Renderiza la pesta√±a actual con los datos procesados
     */
    renderCurrentTab() {
      const c = this._c;
      
      try {
        switch(this.repTab) {
          case 'Platos':
            this.renderPlatosChart();
            break;
          case 'Mozos':
            this.renderMozosChart();
            break;
          case 'Mesas':
            this.renderMesasChart();
            break;
          case 'Clientes':
            this.renderClientesChart();
            break;
          default:
            this.renderGeneralChart();
            break;
        }
      } catch (err) {
        console.error('‚ùå Error renderizando gr√°ficos:', err);
      }
    },
    
    renderGeneralChart() {
      const c = this._c;
      const { labels, valores } = this.chartData1 || { labels: ['Sin datos'], valores: [0] };
      const metodos = this.chartData2?.data || { efectivo: 0, tarjeta: 0, digital: 0 };
      
      createChart('chartReportes1', {
        type: 'line',
        data: {
          labels: labels.length ? labels : ['Sin datos'],
          datasets: [{
            label: 'Ventas (S/.)',
            data: valores.length ? valores : [0],
            borderColor: c.gold,
            backgroundColor: c.goldFill,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: c.gold,
            pointRadius: 4,
            borderWidth: 2
          }]
        },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      createChart('chartReportes2', {
        type: 'doughnut',
        data: {
          labels: ['Efectivo', 'Tarjeta', 'Yape/Plin'],
          datasets: [{ data: [metodos.efectivo || 0, metodos.tarjeta || 0, metodos.digital || 0], backgroundColor: [c.teal, c.blue, c.gold], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 12, font: { size: 11 } } } }, cutout: '60%' }
      });
    },
    
    renderPlatosChart() {
      const c = this._c;
      const cd = this.chartData1 || { labels: ['Sin datos'], vals: [0], colors: [c.gold] };
      
      createChart('chartReportes1', {
        type: 'bar',
        data: {
          labels: cd.labels.length ? cd.labels : ['Sin datos'],
          datasets: [{ label: 'Cantidad vendida', data: cd.vals.length ? cd.vals : [0], backgroundColor: cd.colors || [c.gold], borderWidth: 0, borderRadius: 4 }]
        },
        options: { ...this._baseOpts(), indexAxis: 'y', plugins: { legend: { display: false } } }
      });
      
      const cats = this.chartData2?.data || {};
      const catLabels = Object.keys(cats);
      const catVals = Object.values(cats);
      
      createChart('chartReportes2', {
        type: 'pie',
        data: {
          labels: catLabels.length ? catLabels : ['Sin datos'],
          datasets: [{ data: catVals.length ? catVals : [0], backgroundColor: [c.gold, c.blue, c.teal, c.amber, c.purple, c.red], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } } }
      });
    },
    
    renderMozosChart() {
      const c = this._c;
      const cd = this.chartData1 || { labels: ['Sin datos'], ventas: [0], tickets: [0], propinas: [0] };
      
      createChart('chartReportes1', {
        type: 'bar',
        data: {
          labels: cd.labels.length ? cd.labels : ['Sin datos'],
          datasets: [
            { label: 'Ventas (S/.)', data: cd.ventas.length ? cd.ventas : [0], backgroundColor: c.goldA, borderColor: c.gold, borderWidth: 1, borderRadius: 4 },
            { label: 'Tickets', data: cd.tickets.length ? cd.tickets : [0], backgroundColor: c.blueA, borderColor: c.blue, borderWidth: 1, borderRadius: 4 },
            { label: 'Propinas', data: cd.propinas.length ? cd.propinas : [0], backgroundColor: c.greenA, borderColor: c.green, borderWidth: 1, borderRadius: 4 }
          ]
        },
        options: this._baseOpts()
      });
      
      const cd2 = this.chartData2 || { labels: ['Sin datos'], data: [0] };
      createChart('chartReportes2', {
        type: 'doughnut',
        data: {
          labels: cd2.labels.length ? cd2.labels : ['Sin datos'],
          datasets: [{ data: cd2.data.length ? cd2.data : [0], backgroundColor: [c.gold, c.blue, c.teal, c.amber, c.purple, c.red], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    renderMesasChart() {
      const c = this._c;
      const cd = this.chartData1 || { labels: ['Sin datos'], data: [0] };
      
      createChart('chartReportes1', {
        type: 'bar',
        data: {
          labels: cd.labels.length ? cd.labels : ['Sin datos'],
          datasets: [{ label: 'Comandas', data: cd.data.length ? cd.data : [0], backgroundColor: c.amberA, borderColor: c.amber, borderWidth: 1, borderRadius: 4 }]
        },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      createChart('chartReportes2', {
        type: 'doughnut',
        data: {
          labels: ['Libre', 'Ocupada'],
          datasets: [{ data: [cd.data?.length || 0, 0], backgroundColor: [c.teal, c.amber], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    renderClientesChart() {
      const c = this._c;
      const cd = this.chartData1 || { labels: ['Sin datos'], data: [0] };
      
      createChart('chartReportes1', {
        type: 'line',
        data: {
          labels: cd.labels.length ? cd.labels : ['Sin datos'],
          datasets: [{
            label: 'Visitas',
            data: cd.data.length ? cd.data : [0],
            borderColor: c.gold,
            backgroundColor: c.goldFill,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: c.gold,
            pointRadius: 4,
            borderWidth: 2
          }]
        },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      const cd2 = this.chartData2 || { labels: ['Sin datos'], data: [0] };
      createChart('chartReportes2', {
        type: 'doughnut',
        data: {
          labels: cd2.labels.length ? cd2.labels : ['Sin datos'],
          datasets: [{ data: cd2.data.length ? cd2.data : [0], backgroundColor: ['#5a5a7a', c.blue, c.gold], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    // ==================== UTILIDADES DE UI ====================
    
    /**
     * Obtiene el texto descriptivo del rango actual
     */
    getCurrentRangeText() {
      if (this.dateFilter.tipo === 'manual') {
        return `${this.dateFilter.fechaInicio} al ${this.dateFilter.fechaFin}`;
      }
      return this.dateFilter.tipo;
    },
    
    /**
     * Verifica si un filtro r√°pido est√° activo
     */
    isFilterActive(filtro) {
      return this.dateFilter.tipo === filtro;
    },
    
    /**
     * Muestra una notificaci√≥n toast
     */
    showToast(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Aqu√≠ se puede integrar con un sistema de toasts si existe
    },
    
    // ==================== CONFIGURACI√ìN DE GR√ÅFICOS ====================
    
    _baseOpts(extra = {}) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: this._c.legend,
              font: { size: 11 },
              padding: 12
            }
          }
        },
        scales: {
          x: {
            ticks: { color: this._c.label, font: { size: 10 } },
            grid: { color: this._c.grid }
          },
          y: {
            ticks: { color: this._c.label, font: { size: 10 } },
            grid: { color: this._c.grid }
          }
        },
        ...extra
      };
    },
    
    // ==================== RENDERIZADO POR PESTA√ëA ====================
    // (Las funciones de renderizado est√°n definidas arriba en processAndRender)
    
    logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/login';
    }
  };
}

// ============================================
// FUNCI√ìN CENTRAL: Cargar bouchers por rango (mismo m√©todo que admin.html)
// ============================================
async function cargarBouchersPorRango(fechaInicio, fechaFin) {
  const bouchers = [];
  const fechaInicioDate = new Date(fechaInicio);
  const fechaFinDate = new Date(fechaFin);
  
  console.log('üìÖ Cargando bouchers desde', fechaInicio, 'hasta', fechaFin);
  
  // Iterar por cada d√≠a en el rango
  for (let fecha = new Date(fechaInicioDate); fecha <= fechaFinDate; fecha.setDate(fecha.getDate() + 1)) {
    const fechaStr = fecha.toISOString().split('T')[0];
    try {
      const token = localStorage.getItem('adminToken');
      const response = await fetch(`${API_BASE}/boucher/fecha/${fechaStr}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (response.ok) {
        const bouchersDia = await response.json();
        if (Array.isArray(bouchersDia)) {
          bouchers.push(...bouchersDia.filter(b => b.isActive !== false));
        }
      }
    } catch (error) {
      console.warn(`‚ö†Ô∏è Error cargando bouchers del ${fechaStr}:`, error);
    }
  }
  
  console.log('‚úÖ Total bouchers cargados:', bouchers.length);
  return bouchers;
}
</script>
</body>
</html>
