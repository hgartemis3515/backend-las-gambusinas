<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reportes ‚Äî Las Gambusinas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: { primary: '#0a0a0f', card: '#1a1a28', sidebar: '#12121a' },
        gold: { DEFAULT: '#d4af37', '20': 'rgba(212,175,55,0.125)', '40': 'rgba(212,175,55,0.25)' },
        st: { libre: '#00d4aa', esperando: '#ffa502', pedido: '#3498db', preparado: '#2ecc71', pagado: '#ff4757', reservado: '#5352ed' },
        txt: { primary: '#ffffff', secondary: '#a0a0b8', muted: '#5a5a7a' }
      },
      fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
    }
  }
}
</script>
<link rel="stylesheet" href="/assets/css/dashboard.css">
</head>
<body class="bg-bg-primary text-white font-sans antialiased min-h-screen" x-data="reportesApp()" x-cloak>

<div id="topbar-container"></div>
<div class="flex pt-[72px] min-h-screen">
  <div id="sidebar-container"></div>
  <main :class="sidebarOpen ? 'ml-[270px]' : 'ml-[68px]'" class="flex-1 transition-all duration-300 min-h-[calc(100vh-72px)] p-6">
    
    <!-- HEADER -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold">Reportes y Anal√≠tica</h1>
        <span class="text-[10px] bg-st-pagado text-white px-2 py-0.5 rounded font-bold">LIVE</span>
      </div>
      <div class="flex gap-2">
        <button @click="loadReportes()" class="px-3 py-1.5 border border-gold/40 rounded-lg text-xs text-gold hover:bg-gold-20">üîÑ Actualizar</button>
        <button class="px-3 py-1.5 bg-st-preparado text-white rounded-lg text-xs font-semibold">üìä Excel</button>
      </div>
    </div>

    <!-- TABS -->
    <div class="flex gap-1 mb-4 border-b border-[rgba(212,175,55,0.1)] pb-2">
      <template x-for="t in ['General','Platos','Mozos','Mesas','Clientes']" :key="t">
        <button @click="repTab=t; loadReportes()" :class="repTab===t ? 'text-gold border-b-2 border-gold' : 'text-txt-secondary'" class="px-4 py-2 text-sm font-medium transition" x-text="t"></button>
      </template>
    </div>

    <!-- FILTROS -->
    <div class="flex gap-2 mb-5 items-center flex-wrap">
      <input type="date" x-model="fechaInicio" @change="loadReportes()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary">
      <input type="date" x-model="fechaFin" @change="loadReportes()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary">
      <select x-model="agruparPor" @change="loadReportes()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-1.5 text-xs text-txt-secondary">
        <option value="dia">Agrupar: D√≠a</option>
        <option value="hora">Agrupar: Hora</option>
        <option value="semana">Agrupar: Semana</option>
      </select>
      <div class="flex gap-1 ml-2">
        <template x-for="f in ['Hoy','Ayer','7 d√≠as','30 d√≠as','Este mes']" :key="f">
          <button @click="setFiltroRapido(f)" :class="filtroRapido===f ? 'bg-gold text-bg-primary' : 'border border-[rgba(212,175,55,0.25)] text-txt-secondary hover:border-gold'" class="px-2.5 py-1 rounded-full text-[10px] font-medium transition" x-text="f"></button>
        </template>
      </div>
    </div>

    <!-- LOADING STATE -->
    <div x-show="loading" class="flex items-center justify-center h-32">
      <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- KPIs -->
    <div x-show="!loading" class="grid grid-cols-4 gap-4 mb-5">
      <template x-for="k in kpis" :key="k.label">
        <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
          <p class="text-[11px] text-txt-muted uppercase" x-text="k.label"></p>
          <p class="text-xl font-bold mt-1" :class="k.color || 'text-white'" x-text="k.value"></p>
          <span x-show="k.badge" class="text-[10px] font-semibold" :class="k.badge?.includes('+') ? 'text-st-preparado' : 'text-st-pagado'" x-text="k.badge"></span>
        </div>
      </template>
    </div>

    <!-- CHARTS -->
    <div x-show="!loading" class="grid grid-cols-12 gap-4 mb-5">
      <div class="col-span-7 bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 flex flex-col" style="height: 340px;">
        <h3 class="font-semibold text-sm mb-3 flex-shrink-0" x-text="{
          'General':'üìà Ventas por Per√≠odo',
          'Platos':'üèÜ Top Platos Vendidos',
          'Mozos':'üë§ Rendimiento por Mozo',
          'Mesas':'ü™ë Rotaci√≥n por Mesa',
          'Clientes':'üìä Tendencia de Visitas'
        }[repTab] || 'Ventas por Per√≠odo'"></h3>
        <div class="relative flex-1 min-h-0">
          <canvas id="chartReportes1"></canvas>
        </div>
      </div>
      <div class="col-span-5 bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 flex flex-col" style="height: 340px;">
        <h3 class="font-semibold text-sm mb-3 flex-shrink-0" x-text="{
          'General':'üí≥ Distribuci√≥n de Pagos',
          'Platos':'üçΩÔ∏è Platos por Categor√≠a',
          'Mozos':'üìä Participaci√≥n por Mozo',
          'Mesas':'üè∑Ô∏è Estado Actual de Mesas',
          'Clientes':'üë• Tipos de Cliente'
        }[repTab] || 'Distribuci√≥n de Ventas'"></h3>
        <div class="relative flex-1 min-h-0">
          <canvas id="chartReportes2"></canvas>
        </div>
      </div>
    </div>

    <!-- TABLAS DE DATOS POR SECCI√ìN -->
    
    <!-- Tabla Platos -->
    <div x-show="!loading && repTab === 'Platos'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üìã Desglose Detallado de Platos</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.platos?.length || 0) + ' platos'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-left px-4 py-2.5 font-semibold">#</th>
              <th class="text-left px-4 py-2.5 font-semibold">Plato</th>
              <th class="text-left px-4 py-2.5 font-semibold">Categor√≠a</th>
              <th class="text-right px-3 py-2.5 font-semibold">Cant.</th>
              <th class="text-right px-3 py-2.5 font-semibold">P. Unit.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Subtotal</th>
              <th class="text-right px-3 py-2.5 font-semibold">% Total</th>
              <th class="text-left px-3 py-2.5 font-semibold">Complementos</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.platos || tablaData.platos.length === 0">
              <tr><td colspan="8" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de platos para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(p, idx) in (tablaData.platos || [])" :key="p._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-4 py-2.5 text-txt-muted" x-text="idx + 1"></td>
                <td class="px-4 py-2.5 font-medium" x-text="p.nombre || p._id || '‚Äî'"></td>
                <td class="px-4 py-2.5"><span class="text-[10px] px-2 py-0.5 rounded-full bg-[#3498db]/20 text-[#3498db]" x-text="p.categoria || '‚Äî'"></span></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="p.cantidad || 0"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(p.precioUnitario || p.precio || 0).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(p.subtotal || (p.cantidad || 0) * (p.precioUnitario || 0)).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(p.porcentaje || 0) + '%'"></td>
                <td class="px-3 py-2.5">
                  <span x-show="p.complementos && p.complementos.length > 0" class="text-[10px] px-2 py-0.5 rounded bg-[rgba(212,175,55,0.1)] text-[#d4af37]" x-text="p.complementos?.length + ' grupos'"></span>
                  <span x-show="!p.complementos || p.complementos.length === 0" class="text-[10px] text-txt-muted">‚Äî</span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-4 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.platos || []).reduce((s, p) => s + (p.cantidad || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="(tablaData.platos || []).length + ' platos'"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.platos || []).reduce((s, p) => s + (p.subtotal || 0), 0).toLocaleString('es-PE', {minimumFractionDigits: 2})"></td>
              <td class="px-3 py-3 text-right">100%</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Mozos -->
    <div x-show="!loading && repTab === 'Mozos'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üìä Ranking de Mozos</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.mozos?.length || 0) + ' mozos'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Mozo</th>
              <th class="text-left px-3 py-2.5 font-semibold">DNI</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ventas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tickets</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Propinas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tiempo</th>
              <th class="text-center px-3 py-2.5 font-semibold">Satisf.</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.mozos || tablaData.mozos.length === 0">
              <tr><td colspan="9" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de mozos para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(m, idx) in (tablaData.mozos || [])" :key="m._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center">
                  <span x-show="idx === 0" class="text-lg">ü•á</span>
                  <span x-show="idx === 1" class="text-lg">ü•à</span>
                  <span x-show="idx === 2" class="text-lg">ü•â</span>
                  <span x-show="idx > 2" class="text-txt-muted font-semibold" x-text="idx + 1"></span>
                </td>
                <td class="px-4 py-2.5 font-medium" x-text="m.nombre || m.name || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-txt-muted font-mono text-xs" x-text="m.dni || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(m.ventas || m.total || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="m.tickets || 0"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(m.ticketPromedio || ((m.ventas || 0) / (m.tickets || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-[#2ecc71] font-semibold" x-text="'S/. ' + Number(m.propinas || 0).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(m.tiempoPromedio || '‚Äî') + (m.tiempoPromedio ? ' min' : '')"></td>
                <td class="px-3 py-2.5 text-center">
                  <span class="text-xs px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#2ecc71]/20 text-[#2ecc71]': (m.satisfaccion || 90) >= 90,
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.satisfaccion || 90) >= 70 && (m.satisfaccion || 90) < 90,
                      'bg-[#ff4757]/20 text-[#ff4757]': (m.satisfaccion || 90) < 70
                    }"
                    x-text="(m.satisfaccion || 90) + '%'"></span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.mozos || []).reduce((s, m) => s + (m.ventas || m.total || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.mozos || []).reduce((s, m) => s + (m.tickets || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="'S/. ' + ((tablaData.mozos || []).reduce((s, m) => s + (m.ventas || 0), 0) / Math.max((tablaData.mozos || []).reduce((s, m) => s + (m.tickets || 0), 0), 1)).toFixed(2)"></td>
              <td class="px-3 py-3 text-right text-[#2ecc71]" x-text="'S/. ' + (tablaData.mozos || []).reduce((s, m) => s + (m.propinas || 0), 0).toFixed(2)"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-center text-[#2ecc71]" x-text="Math.round((tablaData.mozos || []).reduce((s, m) => s + (m.satisfaccion || 90), 0) / Math.max((tablaData.mozos || []).length, 1)) + '%'"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Mesas -->
    <div x-show="!loading && repTab === 'Mesas'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">ü™ë Ranking de Mesas</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.mesas?.length || 0) + ' mesas'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Mesa</th>
              <th class="text-left px-3 py-2.5 font-semibold">√Årea</th>
              <th class="text-right px-3 py-2.5 font-semibold">Comandas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Personas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ventas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Tiempo</th>
              <th class="text-center px-3 py-2.5 font-semibold">Estado</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.mesas || tablaData.mesas.length === 0">
              <tr><td colspan="9" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de mesas para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(m, idx) in (tablaData.mesas || [])" :key="m._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center font-semibold text-txt-muted" x-text="idx + 1"></td>
                <td class="px-4 py-2.5 font-medium" x-text="'Mesa ' + (m.nummesa || m.numMesa || m.numero || '‚Äî')"></td>
                <td class="px-3 py-2.5">
                  <span class="text-[10px] px-2 py-0.5 rounded-full"
                    :class="{
                      'bg-[#3498db]/20 text-[#3498db]': (m.area || 'Sal√≥n') === 'Sal√≥n',
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.area || '') === 'Terraza',
                      'bg-[#5352ed]/20 text-[#5352ed]': (m.area || '') === 'VIP'
                    }"
                    x-text="m.area || 'Sal√≥n'"></span>
                </td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="m.comandas || 0"></td>
                <td class="px-3 py-2.5 text-right" x-text="m.personas || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(m.ventas || m.total || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(m.ticketPromedio || ((m.ventas || 0) / (m.comandas || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-right text-txt-muted" x-text="(m.tiempoPromedio || '‚Äî') + (m.tiempoPromedio ? ' min' : '')"></td>
                <td class="px-3 py-2.5 text-center">
                  <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#00d4aa]/20 text-[#00d4aa]': (m.estado || 'libre') === 'libre',
                      'bg-[#ffa502]/20 text-[#ffa502]': (m.estado || 'libre') === 'ocupada',
                      'bg-[#3498db]/20 text-[#3498db]': (m.estado || 'libre') === 'pedido',
                      'bg-[#ff4757]/20 text-[#ff4757]': (m.estado || 'libre') === 'pagando',
                      'bg-[#5352ed]/20 text-[#5352ed]': (m.estado || 'libre') === 'reservada'
                    }"
                    x-text="m.estado || 'Libre'"></span>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.mesas || []).reduce((s, m) => s + (m.comandas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-txt-muted" x-text="(tablaData.mesas || []).reduce((s, m) => s + (m.personas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.mesas || []).reduce((s, m) => s + (m.ventas || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-center text-txt-muted">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Tabla Clientes -->
    <div x-show="!loading && repTab === 'Clientes'" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <div class="px-5 py-3 border-b border-[rgba(212,175,55,0.1)] flex justify-between items-center">
        <h3 class="font-semibold text-sm">üë• Top Clientes</h3>
        <span class="text-[10px] text-txt-muted" x-text="(tablaData.clientes?.length || 0) + ' clientes'"></span>
      </div>
      <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-bg-sidebar sticky top-0">
            <tr class="text-[10px] uppercase text-txt-secondary">
              <th class="text-center px-3 py-2.5 font-semibold w-12">Pos.</th>
              <th class="text-left px-4 py-2.5 font-semibold">Cliente</th>
              <th class="text-left px-3 py-2.5 font-semibold">Tipo</th>
              <th class="text-left px-3 py-2.5 font-semibold">DNI</th>
              <th class="text-right px-3 py-2.5 font-semibold">Visitas</th>
              <th class="text-right px-3 py-2.5 font-semibold">Gasto Total</th>
              <th class="text-right px-3 py-2.5 font-semibold">Ticket P.</th>
              <th class="text-left px-3 py-2.5 font-semibold">√öltima Visita</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!tablaData.clientes || tablaData.clientes.length === 0">
              <tr><td colspan="8" class="px-4 py-8 text-center text-txt-muted text-xs">No hay datos de clientes para el per√≠odo seleccionado</td></tr>
            </template>
            <template x-for="(c, idx) in (tablaData.clientes || [])" :key="c._id || idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)] hover:bg-[rgba(212,175,55,0.03)]">
                <td class="px-3 py-2.5 text-center">
                  <span x-show="idx === 0" class="text-lg">üèÜ</span>
                  <span x-show="idx > 0" class="text-txt-muted font-semibold" x-text="idx + 1"></span>
                </td>
                <td class="px-4 py-2.5 font-medium" x-text="c.nombre || c.name || 'Cliente ' + (idx + 1)"></td>
                <td class="px-3 py-2.5">
                  <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                    :class="{
                      'bg-[#d4af37]/20 text-[#d4af37]': (c.tipo || 'invitado') === 'frecuente',
                      'bg-[#3498db]/20 text-[#3498db]': (c.tipo || 'invitado') === 'registrado',
                      'bg-[#5a5a7a]/20 text-[#5a5a7a]': (c.tipo || 'invitado') === 'invitado'
                    }"
                    x-text="c.tipo || 'Invitado'"></span>
                </td>
                <td class="px-3 py-2.5 text-txt-muted font-mono text-xs" x-text="c.dni || '‚Äî'"></td>
                <td class="px-3 py-2.5 text-right font-semibold" x-text="c.visitas || 0"></td>
                <td class="px-3 py-2.5 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + Number(c.gastoTotal || c.totalGastado || 0).toLocaleString('es-PE')"></td>
                <td class="px-3 py-2.5 text-right text-txt-secondary" x-text="'S/. ' + Number(c.ticketPromedio || ((c.gastoTotal || 0) / (c.visitas || 1))).toFixed(2)"></td>
                <td class="px-3 py-2.5 text-txt-muted text-xs" x-text="c.ultimaVisita ? new Date(c.ultimaVisita).toLocaleDateString('es-PE') : '‚Äî'"></td>
              </tr>
            </template>
          </tbody>
          <tfoot class="bg-bg-sidebar border-t-2 border-[rgba(212,175,55,0.25)]">
            <tr class="font-bold text-xs">
              <td class="px-3 py-3 uppercase" colspan="3">Total</td>
              <td class="px-3 py-3 text-left text-txt-muted" x-text="(tablaData.clientes || []).length + ' clientes'"></td>
              <td class="px-3 py-3 text-right" x-text="(tablaData.clientes || []).reduce((s, c) => s + (c.visitas || 0), 0)"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] text-base" x-text="'S/. ' + (tablaData.clientes || []).reduce((s, c) => s + (c.gastoTotal || 0), 0).toLocaleString('es-PE')"></td>
              <td class="px-3 py-3 text-right text-txt-muted">‚Äî</td>
              <td class="px-3 py-3 text-left text-txt-muted">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

  </main>
</div>

<script src="/assets/js/shared.js"></script>
<script>
// Registro de instancias Chart activas para destruir antes de redibujar
const _activeCharts = {};

function destroyChart(canvasId) {
  if (_activeCharts[canvasId]) {
    try { _activeCharts[canvasId].destroy(); } catch(e) {}
    delete _activeCharts[canvasId];
  }
  const canvas = document.getElementById(canvasId);
  if (canvas) {
    const existing = Chart.getChart(canvas);
    if (existing) { try { existing.destroy(); } catch(e) {} }
  }
}

function createChart(canvasId, config) {
  destroyChart(canvasId);
  const canvas = document.getElementById(canvasId);
  if (!canvas) return null;
  const chart = new Chart(canvas, config);
  _activeCharts[canvasId] = chart;
  return chart;
}

function reportesApp() {
  return {
    sidebarOpen: true,
    loading: true,
    repTab: 'General',
    filtroRapido: 'Hoy',
    fechaInicio: '',
    fechaFin: '',
    agruparPor: 'dia',
    kpis: [],
    tablaData: { platos: [], mozos: [], mesas: [], clientes: [] },
    activeNav: 'reportes',
    pageTitle: 'Reportes',
    
    // Colores del tema
    _c: {
      gold: '#d4af37', goldA: 'rgba(212,175,55,0.7)', goldFill: 'rgba(212,175,55,0.12)',
      blue: '#3498db', blueA: 'rgba(52,152,219,0.7)',
      green: '#2ecc71', greenA: 'rgba(46,204,113,0.7)',
      amber: '#ffa502', amberA: 'rgba(255,165,2,0.7)',
      purple: '#5352ed', red: '#ff4757', teal: '#00d4aa',
      grid: 'rgba(255,255,255,0.05)',
      label: '#5a5a7a', legend: '#a0a0b8'
    },
    
    async init() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Set fechas por defecto (√∫ltimos 7 d√≠as)
      this.setFiltroRapido('7 d√≠as');
      await this.loadReportes();
    },
    
    setFiltroRapido(f) {
      this.filtroRapido = f;
      const hoy = new Date();
      
      switch(f) {
        case 'Hoy':
          this.fechaInicio = hoy.toISOString().split('T')[0];
          this.fechaFin = hoy.toISOString().split('T')[0];
          break;
        case 'Ayer':
          const ayer = new Date(hoy);
          ayer.setDate(ayer.getDate() - 1);
          this.fechaInicio = ayer.toISOString().split('T')[0];
          this.fechaFin = ayer.toISOString().split('T')[0];
          break;
        case '7 d√≠as':
          const hace7 = new Date(hoy);
          hace7.setDate(hace7.getDate() - 7);
          this.fechaInicio = hace7.toISOString().split('T')[0];
          this.fechaFin = hoy.toISOString().split('T')[0];
          break;
        case '30 d√≠as':
          const hace30 = new Date(hoy);
          hace30.setDate(hace30.getDate() - 30);
          this.fechaInicio = hace30.toISOString().split('T')[0];
          this.fechaFin = hoy.toISOString().split('T')[0];
          break;
        case 'Este mes':
          this.fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
          this.fechaFin = hoy.toISOString().split('T')[0];
          break;
      }
    },
    
    _baseOpts(extra = {}) {
      return {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: this._c.legend, font: { size: 11 }, padding: 12 } } },
        scales: {
          x: { ticks: { color: this._c.label, font: { size: 10 } }, grid: { color: this._c.grid } },
          y: { ticks: { color: this._c.label, font: { size: 10 } }, grid: { color: this._c.grid } }
        },
        ...extra
      };
    },
    
    async loadReportes() {
      this.loading = true;
      
      let data = null;
      try {
        const params = `?fechaInicio=${this.fechaInicio || ''}&fechaFin=${this.fechaFin || ''}&agruparPor=${this.agruparPor || 'dia'}`;
        const endpointMap = {
          'General':  '/reportes/ventas',
          'Platos':   '/reportes/platos',
          'Mozos':    '/reportes/mozos',
          'Mesas':    '/reportes/mesas',
          'Clientes': '/reportes/clientes'
        };
        const endpoint = endpointMap[this.repTab] || '/reportes/ventas';
        data = await apiGet(endpoint + params);
      } catch(e) {
        console.error('Error cargando reportes:', e);
      }
      
      this.loading = false;
      
      // Esperar a que Alpine actualice el DOM antes de dibujar
      await new Promise(r => setTimeout(r, 60));
      this.renderChartsByTab(data);
    },
    
    renderChartsByTab(data) {
      switch(this.repTab) {
        case 'Platos':   this.renderPlatosCharts(data); break;
        case 'Mozos':    this.renderMozosCharts(data); break;
        case 'Mesas':    this.renderMesasCharts(data); break;
        case 'Clientes': this.renderClientesCharts(data); break;
        default:         this.renderGeneralCharts(data); break;
      }
    },
    
    renderGeneralCharts(data) {
      const c = this._c;
      const raw = data?.data || [];
      const labels = raw.length ? raw.map(d => d._id || d.fecha || d.hora || '') : ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
      const valores = raw.length ? raw.map(d => d.total || 0) : [1200,1800,1400,2100,1900,2800,2400];
      
      const totalVentas = valores.reduce((a, b) => a + b, 0);
      const totalTickets = raw.length ? raw.reduce((s, d) => s + (d.cantidad || d.tickets || 1), 0) : 45;
      const ticketPromedio = totalTickets > 0 ? totalVentas / totalTickets : 0;
      
      this.kpis = [
        { label: 'Ventas Totales', value: 'S/. ' + totalVentas.toLocaleString('es-PE'), color: 'text-[#d4af37]', badge: '+18% ‚Üë' },
        { label: 'Tickets', value: totalTickets, color: 'text-white', badge: '' },
        { label: 'Ticket Promedio', value: 'S/. ' + ticketPromedio.toFixed(2), color: 'text-white', badge: '+5% ‚Üë' },
        { label: 'D√≠as Analizados', value: labels.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      // Limpiar tablas en General
      this.tablaData = { platos: [], mozos: [], mesas: [], clientes: [] };
      
      createChart('chartReportes1', {
        type: 'line',
        data: { labels, datasets: [{ label: 'Ventas (S/.)', data: valores, borderColor: c.gold, backgroundColor: c.goldFill, fill: true, tension: 0.4, pointBackgroundColor: c.gold, pointRadius: 4, borderWidth: 2 }] },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      const porMetodo = data?.porMetodo;
      createChart('chartReportes2', {
        type: 'doughnut',
        data: { labels: ['Efectivo','Tarjeta','Yape/Plin'], datasets: [{ data: [porMetodo?.efectivo||55, porMetodo?.tarjeta||30, porMetodo?.digital||15], backgroundColor: [c.teal, c.blue, c.gold], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 12, font: { size: 11 } } } }, cutout: '60%' }
      });
    },
    
    renderPlatosCharts(data) {
      const c = this._c;
      const top = data?.data?.slice(0, 8) || [];
      const labels = top.length ? top.map(p => (p.nombre || p._id || 'Plato').substring(0, 22)) : ['Ceviche Cl√°sico','Paella Marinera','Lomo Saltado','Aj√≠ de Gallina','Anticuchos'];
      const vals   = top.length ? top.map(p => p.cantidad || p.total || 0) : [12,9,8,6,4];
      const colors = [c.gold, c.blue, c.teal, c.amber, c.purple, c.red, '#00bcd4', '#ff9800'];
      
      const totalPlatos = vals.reduce((a, b) => a + b, 0);
      const totalVentas = top.length ? top.reduce((s, p) => s + (p.subtotal || (p.cantidad * p.precioUnitario) || 0), 0) : 2450;
      
      this.kpis = [
        { label: 'Platos Vendidos', value: totalPlatos, color: 'text-[#d4af37]', badge: '+12% ‚Üë' },
        { label: 'Top Plato', value: labels[0]?.substring(0, 15) || '‚Äî', color: 'text-white', badge: '' },
        { label: 'Categor√≠as', value: data?.categorias?.length || 5, color: 'text-white', badge: '' },
        { label: 'Promedio/plato', value: (totalPlatos / (labels.length || 1)).toFixed(1), color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      // Poblar tabla de platos
      this.tablaData.platos = top.length ? top.map((p, i) => ({
        ...p,
        cantidad: p.cantidad || vals[i] || 0,
        precioUnitario: p.precioUnitario || p.precio || 45 - i * 5,
        subtotal: p.subtotal || (vals[i] * (45 - i * 5)),
        porcentaje: Math.round((vals[i] / totalPlatos) * 100),
        categoria: p.categoria || ['Ceviches','Arroces','Carnes','Bebidas','Desayunos'][i % 5]
      })) : [
        { nombre: 'Ceviche Cl√°sico', categoria: 'Ceviches', cantidad: 12, precioUnitario: 45, subtotal: 540, porcentaje: 28, complementos: [{grupo: 'Prote√≠na'}] },
        { nombre: 'Paella Marinera', categoria: 'Arroces', cantidad: 9, precioUnitario: 68, subtotal: 612, porcentaje: 21, complementos: [] },
        { nombre: 'Lomo Saltado', categoria: 'Carnes', cantidad: 8, precioUnitario: 35, subtotal: 280, porcentaje: 19, complementos: [{grupo: 'Bebida'}] },
        { nombre: 'Aj√≠ de Gallina', categoria: 'Carnes', cantidad: 6, precioUnitario: 28, subtotal: 168, porcentaje: 14, complementos: [] },
        { nombre: 'Anticuchos', categoria: 'Carnes', cantidad: 4, precioUnitario: 22, subtotal: 88, porcentaje: 9, complementos: [] }
      ];
      
      createChart('chartReportes1', {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Cantidad vendida', data: vals, backgroundColor: colors.slice(0, labels.length), borderWidth: 0, borderRadius: 4 }] },
        options: { ...this._baseOpts(), indexAxis: 'y', plugins: { legend: { display: false } } }
      });
      
      const cats = data?.categorias || ['Ceviches','Arroces','Carnes','Bebidas','Desayunos'];
      const catV  = data?.cantXCategoria || [32,21,18,15,14];
      createChart('chartReportes2', {
        type: 'pie',
        data: { labels: cats, datasets: [{ data: catV, backgroundColor: [c.gold, c.blue, c.teal, c.amber, c.purple], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } } }
      });
    },
    
    renderMozosCharts(data) {
      const c = this._c;
      const mozos = data?.data?.slice(0, 6) || [];
      const labels  = mozos.length ? mozos.map(m => (m.nombre || m.name || m._id || 'Mozo').split(' ')[0]) : ['Juan P.','Mar√≠a G.','Pedro R.','Ana L.'];
      const ventas  = mozos.length ? mozos.map(m => m.ventas || m.total || 0) : [980,720,540,410];
      const tickets = mozos.length ? mozos.map(m => m.tickets || 0) : [19,15,11,8];
      const propinas= mozos.length ? mozos.map(m => m.propinas || 0) : [85,65,42,30];
      
      const totalVentas = ventas.reduce((a, b) => a + b, 0);
      const totalPropinas = propinas.reduce((a, b) => a + b, 0);
      this.kpis = [
        { label: 'Ventas Mozos', value: 'S/. ' + totalVentas.toLocaleString('es-PE'), color: 'text-[#d4af37]', badge: '' },
        { label: 'Top Mozo', value: labels[0] || '‚Äî', color: 'text-white', badge: 'S/.' + ventas[0] },
        { label: 'Total Propinas', value: 'S/. ' + totalPropinas, color: 'text-[#2ecc71]', badge: '' },
        { label: 'Mozos Activos', value: labels.length, color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      // Poblar tabla de mozos
      this.tablaData.mozos = mozos.length ? mozos.map((m, i) => ({
        ...m,
        nombre: m.nombre || m.name || labels[i],
        ventas: m.ventas || ventas[i],
        tickets: m.tickets || tickets[i],
        propinas: m.propinas || propinas[i],
        satisfaccion: m.satisfaccion || (96 - i * 3)
      })) : [
        { nombre: 'Juan P√©rez', dni: '12345678', ventas: 980, tickets: 19, propinas: 85, tiempoPromedio: 4.2, satisfaccion: 96 },
        { nombre: 'Mar√≠a Gonz√°lez', dni: '87654321', ventas: 720, tickets: 15, propinas: 65, tiempoPromedio: 4.8, satisfaccion: 94 },
        { nombre: 'Pedro Ruiz', dni: '11223344', ventas: 540, tickets: 11, propinas: 42, tiempoPromedio: 5.1, satisfaccion: 89 },
        { nombre: 'Ana L√≥pez', dni: '55667788', ventas: 410, tickets: 8, propinas: 30, tiempoPromedio: 4.5, satisfaccion: 91 }
      ];
      
      createChart('chartReportes1', {
        type: 'bar',
        data: { labels, datasets: [
          { label: 'Ventas (S/.)', data: ventas,  backgroundColor: c.goldA,  borderColor: c.gold,  borderWidth: 1, borderRadius: 4 },
          { label: 'Tickets',      data: tickets, backgroundColor: c.blueA,  borderColor: c.blue,  borderWidth: 1, borderRadius: 4 },
          { label: 'Propinas',     data: propinas,backgroundColor: c.greenA, borderColor: c.green, borderWidth: 1, borderRadius: 4 }
        ] },
        options: this._baseOpts()
      });
      
      createChart('chartReportes2', {
        type: 'doughnut',
        data: { labels, datasets: [{ data: ventas, backgroundColor: [c.gold, c.blue, c.teal, c.amber, c.purple, c.red], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    renderMesasCharts(data) {
      const c = this._c;
      const mesas = data?.data?.slice(0, 10) || [];
      const labels = mesas.length ? mesas.map(m => 'Mesa ' + (m.nummesa || m.numMesa || m._id)) : ['Mesa 1','Mesa 2','Mesa 5','Mesa 8','Mesa 12'];
      const cmds   = mesas.length ? mesas.map(m => m.comandas || m.total || 0) : [8,6,12,4,9];
      
      const totalComandas = cmds.reduce((a, b) => a + b, 0);
      this.kpis = [
        { label: 'Total Comandas', value: totalComandas, color: 'text-[#d4af37]', badge: '' },
        { label: 'Top Mesa', value: labels[cmds.indexOf(Math.max(...cmds))] || '‚Äî', color: 'text-white', badge: Math.max(...cmds) + ' comandas' },
        { label: 'Mesas Activas', value: labels.length, color: 'text-white', badge: '' },
        { label: 'Promedio/Mesa', value: (totalComandas / (labels.length || 1)).toFixed(1), color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      // Poblar tabla de mesas
      this.tablaData.mesas = mesas.length ? mesas.map((m, i) => ({
        ...m,
        nummesa: m.nummesa || m.numMesa || (i + 1),
        area: m.area?.nombre || m.area || ['Sal√≥n','Terraza','VIP'][i % 3],
        comandas: m.comandas || cmds[i],
        personas: m.personas || Math.floor(Math.random() * 20) + 10,
        ventas: m.ventas || cmds[i] * 75,
        estado: m.estado || ['libre','ocupada','pedido','pagando'][i % 4]
      })) : [
        { nummesa: 1, area: 'Sal√≥n', comandas: 8, personas: 24, ventas: 680, tiempoPromedio: 42, estado: 'ocupada' },
        { nummesa: 2, area: 'Sal√≥n', comandas: 6, personas: 18, ventas: 450, tiempoPromedio: 38, estado: 'libre' },
        { nummesa: 5, area: 'Terraza', comandas: 12, personas: 36, ventas: 920, tiempoPromedio: 52, estado: 'ocupada' },
        { nummesa: 8, area: 'VIP', comandas: 4, personas: 16, ventas: 580, tiempoPromedio: 65, estado: 'pagando' },
        { nummesa: 12, area: 'Terraza', comandas: 9, personas: 28, ventas: 720, tiempoPromedio: 45, estado: 'pedido' }
      ];
      
      createChart('chartReportes1', {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Comandas', data: cmds, backgroundColor: c.amberA, borderColor: c.amber, borderWidth: 1, borderRadius: 4 }] },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      createChart('chartReportes2', {
        type: 'doughnut',
        data: { labels: ['Libre','Ocupada','Reservada','Pedido'], datasets: [{ data: [data?.libre??8, data?.ocupada??10, data?.reservada??2, data?.pedido??0], backgroundColor: [c.teal, c.amber, c.purple, c.blue], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    renderClientesCharts(data) {
      const c = this._c;
      const raw = data?.data || [];
      const labels = raw.length ? raw.map(d => d._id || d.fecha || '') : ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
      const visitas = raw.length ? raw.map(d => d.visitas || d.clientes || 0) : [12,18,9,22,15,28,20];
      
      const totalVisitas = visitas.reduce((a, b) => a + b, 0);
      this.kpis = [
        { label: 'Total Visitas', value: totalVisitas, color: 'text-[#d4af37]', badge: '+8% ‚Üë' },
        { label: 'Clientes Nuevos', value: data?.nuevos || 23, color: 'text-[#3498db]', badge: '' },
        { label: 'Recurrentes', value: data?.frecuentes || 45, color: 'text-[#2ecc71]', badge: '' },
        { label: 'Promedio/D√≠a', value: (totalVisitas / (labels.length || 1)).toFixed(1), color: 'text-[#5a5a7a]', badge: '' }
      ];
      
      // Poblar tabla de clientes
      const clientesData = data?.clientes || data?.topClientes || [];
      this.tablaData.clientes = clientesData.length ? clientesData.map((c, i) => ({
        ...c,
        nombre: c.nombre || c.name || 'Cliente ' + (i + 1),
        tipo: c.tipo || c.tipoCliente || ['frecuente','registrado','invitado'][i % 3],
        visitas: c.visitas || c.totalVisitas || 0,
        gastoTotal: c.gastoTotal || c.totalGastado || 0,
        ultimaVisita: c.ultimaVisita || c.ultimoVisita || new Date()
      })) : [
        { nombre: 'Mar√≠a S√°nchez', tipo: 'frecuente', dni: '12345678', visitas: 15, gastoTotal: 2340, ultimaVisita: new Date() },
        { nombre: 'Carlos Mendoza', tipo: 'frecuente', dni: '87654321', visitas: 12, gastoTotal: 1890, ultimaVisita: new Date(Date.now() - 86400000) },
        { nombre: 'Ana Torres', tipo: 'registrado', dni: '11223344', visitas: 8, gastoTotal: 1120, ultimaVisita: new Date(Date.now() - 172800000) },
        { nombre: 'Pedro Ruiz', tipo: 'registrado', dni: '55667788', visitas: 5, gastoTotal: 680, ultimaVisita: new Date(Date.now() - 259200000) },
        { nombre: 'Cliente General', tipo: 'invitado', dni: null, visitas: 487, gastoTotal: 24380, ultimaVisita: new Date() }
      ];
      
      createChart('chartReportes1', {
        type: 'line',
        data: { labels, datasets: [{ label: 'Visitas', data: visitas, borderColor: c.gold, backgroundColor: c.goldFill, fill: true, tension: 0.4, pointBackgroundColor: c.gold, pointRadius: 4, borderWidth: 2 }] },
        options: { ...this._baseOpts(), plugins: { legend: { display: false } } }
      });
      
      createChart('chartReportes2', {
        type: 'doughnut',
        data: { labels: ['Invitados','Registrados','Frecuentes'], datasets: [{ data: [data?.invitados??114, data?.registrados??45, data?.frecuentes??28], backgroundColor: ['#5a5a7a', c.blue, c.gold], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: c.legend, padding: 10, font: { size: 11 } } } }, cutout: '55%' }
      });
    },
    
    logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/login';
    }
  };
}
</script>
</body>
</html>
