<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comandas ‚Äî Las Gambusinas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: { primary: '#0a0a0f', card: '#1a1a28', sidebar: '#12121a' },
        gold: { DEFAULT: '#d4af37', '20': 'rgba(212,175,55,0.125)', '40': 'rgba(212,175,55,0.25)' },
        st: { libre: '#00d4aa', esperando: '#ffa502', pedido: '#3498db', preparado: '#2ecc71', pagado: '#ff4757', reservado: '#5352ed' },
        txt: { primary: '#ffffff', secondary: '#a0a0b8', muted: '#5a5a7a' }
      },
      fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
    }
  }
}
</script>
<link rel="stylesheet" href="/assets/css/dashboard.css">
</head>
<body class="bg-bg-primary text-white font-sans antialiased min-h-screen" x-data="comandasApp()" x-cloak>

<div id="topbar-container"></div>
<div class="flex pt-[72px] min-h-screen">
  <div id="sidebar-container"></div>
  <main :class="sidebarOpen ? 'ml-[270px]' : 'ml-[68px]'" class="flex-1 transition-all duration-300 min-h-[calc(100vh-72px)] p-6">
    
    <!-- HEADER -->
    <div class="flex items-center justify-between mb-5">
      <h1 class="text-xl font-bold">Comandas</h1>
      <button @click="loadComandas()" class="px-4 py-2 border border-txt-muted/30 rounded-lg text-sm text-txt-secondary hover:border-gold hover:text-gold transition">üîÑ Actualizar</button>
    </div>

    <!-- FILTROS -->
    <div class="flex gap-2 mb-5 flex-wrap">
      <input type="text" x-model="filterMesa" @input="filterComandas()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-2 text-sm w-28 placeholder-txt-muted" placeholder="Mesa">
      <select x-model="filterEstado" @change="filterComandas()" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-3 py-2 text-sm text-txt-secondary">
        <option value="">Estado: Todos</option>
        <option value="en_espera">En espera</option>
        <option value="recoger">Listo para recoger</option>
        <option value="entregado">Entregado</option>
        <option value="pagado">Pagado</option>
        <option value="cancelado">Cancelado</option>
      </select>
    </div>

    <!-- LOADING STATE -->
    <div x-show="loading && comandas.length === 0" class="flex items-center justify-center h-32">
      <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- TABLA -->
    <div x-show="!loading || comandas.length > 0" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <table class="w-full text-sm">
        <thead><tr class="bg-bg-sidebar text-txt-secondary text-[11px] uppercase">
          <th class="text-left px-4 py-3 font-semibold">#</th>
          <th class="text-left px-4 py-3 font-semibold">Mesa</th>
          <th class="text-left px-4 py-3 font-semibold">Mozo</th>
          <th class="text-left px-4 py-3 font-semibold">Items</th>
          <th class="text-left px-4 py-3 font-semibold">Total</th>
          <th class="text-left px-4 py-3 font-semibold">Estado</th>
          <th class="text-left px-4 py-3 font-semibold">Hora</th>
          <th class="text-left px-4 py-3 font-semibold">Acciones</th>
        </tr></thead>
        <tbody>
          <tr x-show="filteredComandas.length === 0">
            <td colspan="8" class="px-4 py-8 text-center text-txt-muted">No hay comandas</td>
          </tr>
          <template x-for="c in filteredComandas" :key="c._id || c.numComanda">
            <tr class="border-b border-[rgba(212,175,55,0.08)] table-row">
              <td class="px-4 py-3 font-medium" x-text="'#' + (c.numComanda || c._id?.slice(-4) || '‚Äî')"></td>
              <td class="px-4 py-3" x-text="'Mesa ' + (c.mesa?.nummesa || c.mesa?.numMesa || c.mesa || '‚Äî')"></td>
              <td class="px-4 py-3 text-txt-secondary" x-text="c.mozo || '‚Äî'"></td>
              <td class="px-4 py-3" x-text="(c.items?.length || 0) + ' platos'"></td>
              <td class="px-4 py-3 text-gold font-semibold" x-text="'S/. ' + (c.total || 0)"></td>
              <td class="px-4 py-3">
                <span class="text-xs px-2 py-0.5 rounded-full font-semibold cursor-pointer"
                  :class="{
                    'bg-st-preparado/20 text-st-preparado': c.estado === 'recoger' || c.estado === 'preparado',
                    'bg-st-esperando/20 text-st-esperando': c.estado === 'en_espera' || c.estado === 'en cocina',
                    'bg-st-pedido/20 text-st-pedido': c.estado === 'entregado',
                    'bg-st-libre/20 text-st-libre': c.estado === 'pagado',
                    'bg-txt-muted/20 text-txt-muted': c.estado === 'cancelado'
                  }"
                  @click="cambiarEstado(c)" x-text="estadoLabel(c.estado)"></span>
              </td>
              <td class="px-4 py-3 text-txt-muted" x-text="c.createdAt ? new Date(c.createdAt).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : (c.hora || '‚Äî')"></td>
              <td class="px-4 py-3 space-x-2 text-base whitespace-nowrap">
                <span class="cursor-pointer hover:text-[#d4af37] transition" @click="openDetailModal(c)" title="Ver comanda">üëÅ</span>
                <span class="cursor-pointer hover:text-[#d4af37] transition" @click="openEditModal(c)" title="Editar estado">‚úèÔ∏è</span>
                <span class="cursor-pointer hover:text-[#ff4757] transition" @click="eliminarComanda(c._id || c.id)" title="Eliminar comanda">üóëÔ∏è</span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

  </main>
</div>

<!-- MODAL: VER COMANDA ‚Äî Dise√±o seg√∫n pencil-new.pen frame wmbyw -->
<div x-show="modal==='verComanda'" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" @click.self="modal=null">
  <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-2xl w-[840px] max-h-[90vh] overflow-y-auto shadow-2xl" @click.stop>
    
    <!-- HEADER -->
    <div class="bg-bg-sidebar p-5 rounded-t-2xl sticky top-0 z-10">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-bold" x-text="'Comanda #' + (selectedComanda?.numComanda || selectedComanda?.comandaNumber || selectedComanda?._id?.slice(-4) || '‚Äî')"></h2>
            <span class="text-[10px] px-2.5 py-1 rounded-full font-bold"
              :class="{
                'bg-[#2ecc71]/20 text-[#2ecc71]': selectedComanda?.estado === 'recoger' || selectedComanda?.estado === 'preparado',
                'bg-[#ffa502]/20 text-[#ffa502]': selectedComanda?.estado === 'en_espera' || selectedComanda?.estado === 'en cocina',
                'bg-[#3498db]/20 text-[#3498db]': selectedComanda?.estado === 'entregado',
                'bg-[#00d4aa]/20 text-[#00d4aa]': selectedComanda?.estado === 'pagado',
                'bg-[#ff4757]/20 text-[#ff4757]': selectedComanda?.estado === 'cancelado'
              }"
              x-text="estadoLabel(selectedComanda?.estado)"></span>
          </div>
          <p class="text-xs text-txt-muted mt-0.5">
            <span x-text="'Mesa ' + (selectedComanda?.mesa?.nummesa || selectedComanda?.mesa?.numMesa || selectedComanda?.mesa || '‚Äî')"></span>
            <template x-if="selectedComanda?.mozo"><span> ‚Äî <span x-text="selectedComanda.mozo"></span></span></template>
          </p>
        </div>
        <button @click="modal=null" class="w-8 h-8 flex items-center justify-center rounded-full bg-[rgba(212,175,55,0.1)] text-[#d4af37] hover:bg-[rgba(212,175,55,0.2)] transition text-sm font-bold">‚úï</button>
      </div>
    </div>

    <div class="p-5 space-y-4">
      
      <!-- INFO GENERAL -->
      <div class="bg-[#0a0a0f] border border-[rgba(212,175,55,0.15)] rounded-xl p-4">
        <p class="text-[10px] text-[#5a5a7a] uppercase mb-3 font-semibold tracking-wider">Informaci√≥n General</p>
        <div class="grid grid-cols-3 gap-3 text-sm mb-3">
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Creada</p>
            <p class="font-medium" x-text="selectedComanda?.createdAt ? new Date(selectedComanda.createdAt).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : (selectedComanda?.hora || '‚Äî')"></p>
          </div>
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Enviada a cocina</p>
            <p class="font-medium" x-text="selectedComanda?.tiempoEnEspera ? new Date(selectedComanda.tiempoEnEspera).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Preparada</p>
            <p class="font-medium text-[#2ecc71]" x-text="selectedComanda?.tiempoRecoger ? new Date(selectedComanda.tiempoRecoger).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-sm border-t border-[rgba(212,175,55,0.1)] pt-3">
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Mozo</p>
            <p class="font-medium" x-text="selectedComanda?.mozo || '‚Äî'"></p>
          </div>
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Observaciones</p>
            <p class="font-medium text-[#a0a0b8]" x-text="selectedComanda?.observaciones || 'Sin observaciones'"></p>
          </div>
          <div>
            <p class="text-[10px] text-[#5a5a7a]">Versi√≥n</p>
            <p class="font-medium text-[#a0a0b8]" x-text="'v' + (selectedComanda?.version || 1)"></p>
          </div>
        </div>
      </div>

      <!-- TABLA DE PLATOS -->
      <div class="bg-[#0a0a0f] border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-[#12121a] text-[#a0a0b8] text-[10px] uppercase">
              <th class="text-left px-4 py-2.5 font-semibold">Plato</th>
              <th class="text-center px-3 py-2.5 font-semibold">Cant.</th>
              <th class="text-right px-3 py-2.5 font-semibold">P. Unit.</th>
              <th class="text-right px-3 py-2.5 font-semibold">Subtotal</th>
              <th class="text-left px-3 py-2.5 font-semibold">Complementos</th>
            </tr>
          </thead>
          <tbody>
            <template x-if="!selectedComanda?.items || selectedComanda.items.length === 0">
              <tr><td colspan="5" class="px-4 py-6 text-center text-[#5a5a7a] text-xs">Sin platos registrados</td></tr>
            </template>
            <template x-for="(item, idx) in (selectedComanda?.items || [])" :key="idx">
              <tr class="border-b border-[rgba(212,175,55,0.08)]">
                <td class="px-4 py-3">
                  <p class="font-medium" x-text="item.plato?.nombre || item.nombre || '‚Äî'"></p>
                  <p class="text-[10px] text-[#5a5a7a]" x-show="item.notaEspecial" x-text="'üìù ' + item.notaEspecial"></p>
                </td>
                <td class="px-3 py-3 text-center font-semibold" x-text="item.cantidad || 1"></td>
                <td class="px-3 py-3 text-right text-[#a0a0b8]" x-text="'S/. ' + Number(item.plato?.precio || item.precio || item.precioUnitario || 0).toFixed(2)"></td>
                <td class="px-3 py-3 text-right text-[#d4af37] font-semibold" x-text="'S/. ' + ((item.cantidad || 1) * Number(item.plato?.precio || item.precio || item.precioUnitario || 0)).toFixed(2)"></td>
                <td class="px-3 py-3">
                  <template x-if="item.complementosSeleccionados && item.complementosSeleccionados.length > 0">
                    <div class="flex flex-wrap gap-1">
                      <template x-for="comp in item.complementosSeleccionados" :key="comp.grupo">
                        <span class="text-[9px] px-1.5 py-0.5 rounded bg-[rgba(212,175,55,0.1)] text-[#d4af37]" x-text="comp.grupo + ': ' + comp.opcion"></span>
                      </template>
                    </div>
                  </template>
                  <template x-if="!item.complementosSeleccionados || item.complementosSeleccionados.length === 0">
                    <span class="text-[10px] text-[#5a5a7a]">‚Äî</span>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot>
            <tr class="border-t-2 border-[rgba(212,175,55,0.25)] bg-[#12121a]">
              <td class="px-4 py-3 font-bold text-xs uppercase" colspan="2">TOTAL</td>
              <td class="px-3 py-3 text-right text-xs text-[#5a5a7a]" x-text="(selectedComanda?.items || []).reduce((s, i) => s + (i.cantidad || 1), 0) + ' platos'"></td>
              <td class="px-3 py-3 text-right text-[#d4af37] font-bold text-lg" x-text="'S/. ' + Number(selectedComanda?.total || selectedComanda?.precioTotal || 0).toFixed(2)"></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- TIMELINE DE ESTADOS -->
      <div class="bg-[#0a0a0f] border border-[rgba(212,175,55,0.15)] rounded-xl p-4">
        <p class="text-[10px] text-[#5a5a7a] uppercase mb-4 font-semibold tracking-wider">Historial de Estados</p>
        <div class="relative flex items-start justify-between">
          <div class="absolute top-1.5 left-0 right-0 h-0.5 bg-[rgba(212,175,55,0.15)]" style="margin: 0 6%"></div>
          <!-- Creada -->
          <div class="flex flex-col items-center flex-1 relative z-10">
            <div class="w-3 h-3 rounded-full bg-[#3498db] mb-2"></div>
            <p class="text-[10px] font-semibold text-[#3498db]">Creada</p>
            <p class="text-[9px] text-[#5a5a7a]" x-text="selectedComanda?.createdAt ? new Date(selectedComanda.createdAt).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
          <!-- En cocina -->
          <div class="flex flex-col items-center flex-1 relative z-10">
            <div class="w-3 h-3 rounded-full mb-2" :class="selectedComanda?.tiempoEnEspera ? 'bg-[#ffa502]' : 'bg-[#5a5a7a]/30'"></div>
            <p class="text-[10px] font-semibold" :class="selectedComanda?.tiempoEnEspera ? 'text-[#ffa502]' : 'text-[#5a5a7a]'">En cocina</p>
            <p class="text-[9px] text-[#5a5a7a]" x-text="selectedComanda?.tiempoEnEspera ? new Date(selectedComanda.tiempoEnEspera).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
          <!-- Preparado -->
          <div class="flex flex-col items-center flex-1 relative z-10">
            <div class="w-3 h-3 rounded-full mb-2" :class="selectedComanda?.tiempoRecoger ? 'bg-[#2ecc71]' : 'bg-[#5a5a7a]/30'"></div>
            <p class="text-[10px] font-semibold" :class="selectedComanda?.tiempoRecoger ? 'text-[#2ecc71]' : 'text-[#5a5a7a]'">Preparado</p>
            <p class="text-[9px] text-[#5a5a7a]" x-text="selectedComanda?.tiempoRecoger ? new Date(selectedComanda.tiempoRecoger).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
          <!-- Entregado -->
          <div class="flex flex-col items-center flex-1 relative z-10">
            <div class="w-3 h-3 rounded-full mb-2" :class="selectedComanda?.tiempoEntregado ? 'bg-[#d4af37]' : 'bg-[#5a5a7a]/30'"></div>
            <p class="text-[10px] font-semibold" :class="selectedComanda?.tiempoEntregado ? 'text-[#d4af37]' : 'text-[#5a5a7a]'">Entregado</p>
            <p class="text-[9px] text-[#5a5a7a]" x-text="selectedComanda?.tiempoEntregado ? new Date(selectedComanda.tiempoEntregado).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
          <!-- Pagado -->
          <div class="flex flex-col items-center flex-1 relative z-10">
            <div class="w-3 h-3 rounded-full mb-2" :class="selectedComanda?.tiempoPagado ? 'bg-[#00d4aa]' : 'bg-[#5a5a7a]/30'"></div>
            <p class="text-[10px] font-semibold" :class="selectedComanda?.tiempoPagado ? 'text-[#00d4aa]' : 'text-[#5a5a7a]'">Pagado</p>
            <p class="text-[9px] text-[#5a5a7a]" x-text="selectedComanda?.tiempoPagado ? new Date(selectedComanda.tiempoPagado).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '‚Äî'"></p>
          </div>
        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <div class="bg-[#12121a] p-4 rounded-b-2xl flex justify-between items-center border-t border-[rgba(212,175,55,0.1)]">
      <button @click="modal=null" class="px-4 py-2 border border-[#5a5a7a]/40 rounded-lg text-sm text-[#a0a0b8] hover:border-[#d4af37] hover:text-[#d4af37] transition">Cerrar</button>
      <div class="flex gap-2">
        <button class="px-4 py-2 border border-[rgba(212,175,55,0.4)] text-[#d4af37] rounded-lg text-sm font-medium hover:bg-[rgba(212,175,55,0.1)] transition">üñ® PDF</button>
        <button class="px-4 py-2 bg-[#d4af37] text-[#0a0a0f] rounded-lg text-sm font-semibold hover:brightness-110 transition">üç≥ Cocina</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR ESTADO COMANDA -->
<div x-show="modal==='editarComanda'" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" @click.self="modal=null">
  <div class="bg-[#1a1a28] border border-[rgba(212,175,55,0.25)] rounded-2xl w-[480px] shadow-2xl" @click.stop>
    <div class="bg-[#12121a] p-5 rounded-t-2xl flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold" x-text="'Editar Comanda #' + (editComanda?.numComanda || editComanda?.comandaNumber || '‚Äî')"></h2>
        <p class="text-xs text-[#5a5a7a]" x-text="'Mesa ' + (editComanda?.mesa?.nummesa || editComanda?.mesa?.numMesa || editComanda?.mesa || '‚Äî')"></p>
      </div>
      <button @click="modal=null" class="w-7 h-7 flex items-center justify-center rounded-full bg-[rgba(212,175,55,0.1)] text-[#d4af37] text-sm">‚úï</button>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="text-xs text-[#a0a0b8] mb-2 block font-semibold">Estado de la Comanda</label>
        <select x-model="editComanda.estado" class="w-full bg-[#12121a] border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm focus:border-[#d4af37] focus:outline-none text-white">
          <option value="en_espera">‚è≥ En espera</option>
          <option value="recoger">‚úÖ Listo para recoger</option>
          <option value="entregado">üöÄ Entregado</option>
          <option value="pagado">üí∞ Pagado</option>
          <option value="cancelado">‚ùå Cancelado</option>
        </select>
      </div>
      <div>
        <label class="text-xs text-[#a0a0b8] mb-2 block font-semibold">Observaciones</label>
        <textarea x-model="editComanda.observaciones" placeholder="Notas adicionales..." class="w-full bg-[#12121a] border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm h-20 resize-none focus:border-[#d4af37] focus:outline-none text-white"></textarea>
      </div>
    </div>
    <div class="bg-[#12121a] p-5 rounded-b-2xl flex justify-end gap-2 border-t border-[rgba(212,175,55,0.15)]">
      <button @click="modal=null" class="px-5 py-2.5 border border-[#5a5a7a]/40 rounded-lg text-sm text-[#a0a0b8] hover:border-[#d4af37] hover:text-[#d4af37] transition">Cancelar</button>
      <button @click="guardarEdicionComanda()" class="px-5 py-2.5 bg-[#d4af37] text-[#0a0a0f] rounded-lg text-sm font-semibold hover:brightness-110 transition">Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed bottom-6 right-6 z-[9999] space-y-2"></div>

<script src="/assets/js/shared.js"></script>
<script>
function comandasApp() {
  return {
    sidebarOpen: true,
    modal: null,
    loading: true,
    comandas: [],
    filteredComandas: [],
    selectedComanda: null,
    editComanda: { _id: null, estado: '', observaciones: '', numComanda: null, mesa: null },
    filterMesa: '',
    filterEstado: '',
    activeNav: 'comandas',
    pageTitle: 'Comandas',
    
    async init() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      await this.loadComandas();
    },
    
    async loadComandas() {
      this.loading = true;
      // Probar ambos endpoints: /comanda (real) y /comandas (alias)
      let data = await apiGet('/comanda');
      if (!data) data = await apiGet('/comandas');
      
      let raw = [];
      if (data && Array.isArray(data)) raw = data;
      else if (data && data.comandas) raw = data.comandas;
      else if (data && data.data) raw = data.data;
      
      // Normalizar campos del modelo real a los esperados por la UI
      this.comandas = raw.map(c => ({
        ...c,
        numComanda: c.comandaNumber || c.numComanda,
        mesa: c.mesas || c.mesa,
        mozo: c.mozos?.name || c.mozos || c.idMozo?.nombre || c.mozo,
        items: c.platos || c.items || [],
        total: c.precioTotal || c.total || 0,
        estado: c.status || c.estado || 'pendiente',
      }));
      
      this.filterComandas();
      this.loading = false;
    },
    
    filterComandas() {
      this.filteredComandas = this.comandas.filter(c => {
        const mesaNum = c.mesa?.nummesa || c.mesa?.numMesa || c.mesa;
        const matchMesa = !this.filterMesa || String(mesaNum || '').includes(this.filterMesa);
        const matchEstado = !this.filterEstado || c.estado === this.filterEstado;
        return matchMesa && matchEstado;
      });
    },
    
    estadoLabel(estado) {
      const map = {
        'en_espera': 'En espera',
        'recoger': 'Listo para recoger',
        'entregado': 'Entregado',
        'pagado': 'Pagado',
        'cancelado': 'Cancelado',
        'en cocina': 'En cocina',
        'preparado': 'Preparado',
        'pendiente': 'Pendiente'
      };
      return map[estado] || estado || 'pendiente';
    },
    
    openDetailModal(c) {
      this.selectedComanda = c;
      this.modal = 'verComanda';
    },
    
    openEditModal(c) {
      this.editComanda = {
        _id: c._id,
        estado: c.estado || 'en_espera',
        observaciones: c.observaciones || '',
        numComanda: c.numComanda || c.comandaNumber,
        mesa: c.mesa,
      };
      this.modal = 'editarComanda';
    },
    
    async guardarEdicionComanda() {
      if (!this.editComanda._id) return;
      const res = await apiPut('/comanda/' + this.editComanda._id, {
        status: this.editComanda.estado,
        observaciones: this.editComanda.observaciones
      });
      if (res && !res.error) {
        await this.loadComandas();
        this.modal = null;
        this.showToast('Comanda actualizada ‚úÖ');
      } else {
        alert('Error al actualizar: ' + (res?.error || res?.message || 'Fallo desconocido'));
      }
    },
    
    async eliminarComanda(id) {
      if (!id) return;
      if (!confirm('¬øEliminar esta comanda? Esta acci√≥n quedar√° registrada en auditor√≠a.')) return;
      const res = await apiDelete('/comanda/' + id);
      if (res && !res.error) {
        await this.loadComandas();
        this.showToast('Comanda eliminada ‚úÖ');
      } else {
        alert('Error al eliminar: ' + (res?.error || res?.message || 'Fallo desconocido'));
      }
    },
    
    async cambiarEstado(c) {
      const estados = ['en cocina', 'preparado', 'entregado'];
      const idx = estados.indexOf(c.estado);
      const nuevoEstado = estados[(idx + 1) % estados.length];
      
      const res = await apiPut('/comandas/' + c._id, { estado: nuevoEstado });
      if (res && !res.error) {
        c.estado = nuevoEstado;
        this.showToast('Estado actualizado a "' + nuevoEstado + '"');
      }
    },
    
    showToast(msg, type = 'success') {
      const container = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'px-4 py-3 rounded-xl text-sm font-medium shadow-xl ' +
        (type === 'error' ? 'bg-st-pagado text-white' : 'bg-st-preparado text-white');
      t.textContent = msg;
      container.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    },
    
    logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/login';
    }
  };
}
</script>
</body>
</html>
