<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roles y Permisos ‚Äî Las Gambusinas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: { primary: '#0a0a0f', card: '#1a1a28', sidebar: '#12121a' },
        gold: { DEFAULT: '#d4af37', '20': 'rgba(212,175,55,0.125)', '40': 'rgba(212,175,55,0.25)' },
        st: { libre: '#00d4aa', esperando: '#ffa502', pedido: '#3498db', preparado: '#2ecc71', pagado: '#ff4757', reservado: '#5352ed' },
        txt: { primary: '#ffffff', secondary: '#a0a0b8', muted: '#5a5a7a' }
      },
      fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
    }
  }
}
</script>
<link rel="stylesheet" href="/assets/css/dashboard.css">
</head>
<body class="bg-bg-primary text-white font-sans antialiased min-h-screen" x-data="rolesApp()" x-cloak>

<div id="topbar-container"></div>
<div class="flex pt-[72px] min-h-screen">
  <div id="sidebar-container"></div>
  <main :class="sidebarOpen ? 'ml-[270px]' : 'ml-[68px]'" class="flex-1 transition-all duration-300 min-h-[calc(100vh-72px)] p-6">
    
    <!-- HEADER -->
    <div class="flex items-center justify-between mb-5">
      <div>
        <h1 class="text-xl font-bold">Gesti√≥n de Roles y Permisos</h1>
        <p class="text-txt-muted text-sm mt-1">Asigna roles y permisos a los usuarios del sistema</p>
      </div>
      <button class="bg-gold text-bg-primary px-4 py-2 rounded-lg text-sm font-semibold hover:brightness-110 transition" @click="openCreateModal()">
        + Nuevo Rol
      </button>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
        <p class="text-[11px] text-txt-muted uppercase">Total Roles</p>
        <p class="text-2xl font-bold text-white mt-1" x-text="roles.length"></p>
      </div>
      <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
        <p class="text-[11px] text-txt-muted uppercase">Roles Sistema</p>
        <p class="text-2xl font-bold text-gold mt-1" x-text="roles.filter(r=>r.esSistema).length"></p>
      </div>
      <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
        <p class="text-[11px] text-txt-muted uppercase">Roles Personalizados</p>
        <p class="text-2xl font-bold text-st-preparado mt-1" x-text="roles.filter(r=>!r.esSistema).length"></p>
      </div>
      <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4">
        <p class="text-[11px] text-txt-muted uppercase">Permisos Disponibles</p>
        <p class="text-2xl font-bold text-st-pedido mt-1" x-text="permisosFundamentales.length"></p>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-4 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[200px]">
          <input type="text" x-model="busqueda" placeholder="Buscar por nombre de rol..." 
            class="w-full bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2 text-sm focus:border-gold focus:outline-none">
        </div>
        <div class="flex gap-2">
          <select x-model="filtroTipo" class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2 text-sm text-txt-secondary focus:border-gold focus:outline-none">
            <option value="">Todos los tipos</option>
            <option value="sistema">Sistema</option>
            <option value="personalizado">Personalizados</option>
          </select>
        </div>
      </div>
    </div>

    <!-- LOADING STATE -->
    <div x-show="loading && roles.length === 0" class="flex items-center justify-center h-32">
      <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- TABLA DE ROLES -->
    <div x-show="!loading || roles.length > 0" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl overflow-hidden">
      <table class="w-full text-sm">
        <thead><tr class="bg-bg-sidebar text-txt-secondary text-[11px] uppercase">
          <th class="text-left px-4 py-3 font-semibold">Rol</th>
          <th class="text-left px-4 py-3 font-semibold">Tipo</th>
          <th class="text-left px-4 py-3 font-semibold">Descripci√≥n</th>
          <th class="text-left px-4 py-3 font-semibold">Permisos</th>
          <th class="text-left px-4 py-3 font-semibold">Estado</th>
          <th class="text-left px-4 py-3 font-semibold">Acciones</th>
        </tr></thead>
        <tbody>
          <tr x-show="rolesFiltrados.length === 0">
            <td colspan="6" class="px-4 py-8 text-center text-txt-muted">No se encontraron roles</td>
          </tr>
          <template x-for="rol in rolesFiltrados" :key="rol._id || rol.id">
            <tr class="border-b border-[rgba(212,175,55,0.08)] table-row hover:bg-bg-sidebar/50">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="text-xs px-3 py-1.5 rounded-full font-bold" 
                    :class="{
                      'bg-gold/20 text-gold': rol.color === 'gold',
                      'bg-st-preparado/20 text-st-preparado': rol.color === 'st-preparado',
                      'bg-st-pedido/20 text-st-pedido': rol.color === 'st-pedido',
                      'bg-st-libre/20 text-st-libre': rol.color === 'st-libre' || !rol.color,
                      'bg-st-esperando/20 text-st-esperando': rol.color === 'st-esperando',
                      'bg-st-pagado/20 text-st-pagado': rol.color === 'st-pagado',
                      'bg-st-reservado/20 text-st-reservado': rol.color === 'st-reservado'
                    }" x-text="rol.nombreDisplay || rol.nombre"></span>
                </div>
              </td>
              <td class="px-4 py-3">
                <span x-show="rol.esSistema" class="text-[10px] bg-gold/10 text-gold px-2 py-0.5 rounded">SISTEMA</span>
                <span x-show="!rol.esSistema" class="text-[10px] bg-st-preparado/10 text-st-preparado px-2 py-0.5 rounded">PERSONALIZADO</span>
              </td>
              <td class="px-4 py-3 text-txt-secondary text-xs" x-text="rol.descripcion || '‚Äî'"></td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-1 max-w-[300px]">
                  <template x-for="(p, i) in getTopPermisos(rol.permisos, 4)" :key="i">
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-bg-sidebar text-txt-secondary" x-text="p"></span>
                  </template>
                  <span x-show="rol.permisos?.length > 4" class="text-[10px] px-1.5 py-0.5 rounded bg-gold/20 text-gold" x-text="'+' + (rol.permisos?.length - 4) + ' m√°s'"></span>
                </div>
              </td>
              <td class="px-4 py-3">
                <span class="text-xs px-2 py-0.5 rounded-full font-semibold" 
                  :class="rol.activo !== false ? 'bg-st-preparado/20 text-st-preparado' : 'bg-txt-muted/20 text-txt-muted'"
                  x-text="rol.activo !== false ? 'Activo' : 'Inactivo'"></span>
              </td>
              <td class="px-4 py-3 space-x-2 text-base">
                <span class="cursor-pointer hover:text-gold" @click="openEditModal(rol)" title="Editar permisos">‚úèÔ∏è</span>
                <span class="cursor-pointer hover:text-st-pedido" @click="verPermisos(rol)" title="Ver todos los permisos">üìã</span>
                <span x-show="!rol.esSistema" class="cursor-pointer hover:text-st-pagado" @click="eliminarRol(rol)" title="Eliminar rol">üóëÔ∏è</span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

  </main>
</div>

<!-- MODAL: EDITAR ROL -->
<div x-show="modalEditar" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay bg-black/70" @click.self="modalEditar=false">
  <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-2xl w-[800px] max-h-[90vh] overflow-hidden shadow-2xl" @click.stop>
    <div class="bg-bg-sidebar p-5 rounded-t-2xl flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold" x-text="isEditing ? 'Editar Rol' : 'Crear Nuevo Rol'"></h2>
        <p class="text-xs text-txt-muted" x-text="formRol.esSistema ? 'Ver permisos del rol del sistema' : 'Configura los permisos del rol'"></p>
      </div>
      <button @click="modalEditar=false" class="w-7 h-7 flex items-center justify-center rounded-full bg-gold-20 text-gold text-sm">‚úï</button>
    </div>
    
    <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-txt-secondary mb-1 block">Nombre del Rol</label>
          <input type="text" x-model="formRol.nombreDisplay" placeholder="Ej: Gerente" 
            class="w-full bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm focus:border-gold focus:outline-none"
            :disabled="formRol.esSistema">
        </div>
        <div>
          <label class="text-xs text-txt-secondary mb-1 block">Color</label>
          <select x-model="formRol.color" class="w-full bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm focus:border-gold focus:outline-none" :disabled="formRol.esSistema">
            <option value="gold">Dorado</option>
            <option value="st-preparado">Verde</option>
            <option value="st-pedido">Azul</option>
            <option value="st-libre">Turquesa</option>
            <option value="st-esperando">Naranja</option>
            <option value="st-pagado">Rojo</option>
            <option value="st-reservado">P√∫rpura</option>
          </select>
        </div>
      </div>
      
      <div>
        <label class="text-xs text-txt-secondary mb-1 block">Descripci√≥n</label>
        <input type="text" x-model="formRol.descripcion" placeholder="Descripci√≥n del rol" 
          class="w-full bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm focus:border-gold focus:outline-none"
          :disabled="formRol.esSistema">
      </div>
      
      <!-- Permisos por Grupo -->
      <div class="border-t border-[rgba(212,175,55,0.15)] pt-4">
        <div class="flex items-center justify-between mb-3">
          <label class="text-xs text-txt-secondary font-medium">Permisos</label>
          <span x-show="!formRol.esSistema" class="text-[11px] text-gold cursor-pointer hover:underline" @click="seleccionarTodosPermisos()">Seleccionar todos</span>
        </div>
        
        <template x-for="(permisosGrupo, grupo) in permisosAgrupados" :key="grupo">
          <div class="mb-4">
            <p class="text-[11px] text-txt-muted uppercase mb-2 font-semibold" x-text="grupo"></p>
            <div class="grid grid-cols-3 gap-2">
              <template x-for="permiso in permisosGrupo" :key="permiso.id">
                <label class="flex items-center gap-2 p-2 rounded-lg bg-bg-sidebar border border-[rgba(212,175,55,0.1)] cursor-pointer hover:border-gold/30 transition"
                  :class="{'opacity-60 cursor-not-allowed': formRol.esSistema}">
                  <input type="checkbox" 
                    :checked="formRol.permisos.includes(permiso.id)"
                    @change="togglePermiso(permiso.id)"
                    :disabled="formRol.esSistema"
                    class="w-4 h-4 rounded border-[rgba(212,175,55,0.25)] bg-bg-sidebar text-gold focus:ring-gold">
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-medium truncate" x-text="permiso.nombre"></p>
                    <p class="text-[10px] text-txt-muted truncate" x-text="permiso.descripcion"></p>
                  </div>
                </label>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div class="bg-bg-sidebar p-5 rounded-b-2xl flex justify-end gap-2 border-t border-[rgba(212,175,55,0.15)]">
      <button @click="modalEditar=false" class="px-5 py-2.5 border border-txt-muted/30 rounded-lg text-sm text-txt-secondary hover:border-gold hover:text-gold transition">Cancelar</button>
      <button x-show="!formRol.esSistema" @click="guardarRol()" class="px-5 py-2.5 bg-gold text-bg-primary rounded-lg text-sm font-semibold hover:brightness-110 transition" x-text="isEditing ? 'Actualizar' : 'Crear Rol'"></button>
    </div>
  </div>
</div>

<!-- MODAL: VER PERMISOS -->
<div x-show="modalPermisos" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay bg-black/70" @click.self="modalPermisos=false">
  <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-2xl w-[500px] max-h-[90vh] overflow-hidden shadow-2xl" @click.stop>
    <div class="bg-bg-sidebar p-5 rounded-t-2xl flex items-center justify-between">
      <div>
        <h2 class="text-lg font-bold" x-text="'Permisos de ' + (rolDetalle?.nombreDisplay || rolDetalle?.nombre)"></h2>
        <p class="text-xs text-txt-muted" x-text="rolDetalle?.permisos?.length + ' permisos asignados'"></p>
      </div>
      <button @click="modalPermisos=false" class="w-7 h-7 flex items-center justify-center rounded-full bg-gold-20 text-gold text-sm">‚úï</button>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[60vh]">
      <div class="space-y-1">
        <template x-for="permiso in rolDetalle?.permisos" :key="permiso">
          <div class="flex items-center gap-2 p-2 rounded-lg bg-bg-sidebar">
            <span class="text-st-preparado text-xs">‚úì</span>
            <span class="text-sm" x-text="getNombrePermiso(permiso)"></span>
          </div>
        </template>
      </div>
    </div>

    <div class="bg-bg-sidebar p-5 rounded-b-2xl flex justify-end border-t border-[rgba(212,175,55,0.15)]">
      <button @click="modalPermisos=false" class="px-5 py-2.5 bg-gold text-bg-primary rounded-lg text-sm font-semibold hover:brightness-110 transition">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed bottom-6 right-6 z-[9999] space-y-2"></div>

<script src="/assets/js/shared.js"></script>
<script>
function rolesApp() {
  return {
    sidebarOpen: true,
    loading: true,
    roles: [],
    permisosFundamentales: [],
    permisosAgrupados: {},
    busqueda: '',
    filtroTipo: '',
    modalEditar: false,
    modalPermisos: false,
    isEditing: false,
    formRol: {
      _id: null,
      nombre: '',
      nombreDisplay: '',
      descripcion: '',
      permisos: [],
      color: 'st-libre',
      esSistema: false
    },
    rolDetalle: null,
    activeNav: 'roles',
    pageTitle: 'Roles',
    
    async init() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Verificar que sea admin
      const userData = this.parseJwt(token);
      if (userData.rol !== 'admin') {
        this.showToast('Solo administradores pueden gestionar roles', 'error');
        setTimeout(() => window.location.href = '/index.html', 1500);
        return;
      }
      
      await this.cargarDatos();
    },
    
    parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        return {};
      }
    },
    
    async cargarDatos() {
      this.loading = true;
      
      try {
        // Cargar permisos
        const permisosRes = await apiGet('/roles/permisos');
        if (permisosRes && permisosRes.success) {
          this.permisosFundamentales = permisosRes.data.permisos;
          this.permisosAgrupados = permisosRes.data.permisosAgrupados;
        } else {
          console.error('Error al cargar permisos:', permisosRes);
        }
        
        // Cargar roles
        const rolesRes = await apiGet('/roles');
        if (rolesRes && rolesRes.success) {
          this.roles = rolesRes.data;
        } else {
          console.error('Error al cargar roles:', rolesRes);
          // Si el error indica que no tiene permisos, mostrar mensaje
          if (rolesRes && rolesRes.error) {
            if (rolesRes.error.includes('permisos') || rolesRes.error.includes('rol')) {
              this.showToast('Tu sesi√≥n no tiene rol asignado. Por favor, vuelve a iniciar sesi√≥n.', 'error');
              // Opcional: redirigir al login despu√©s de 3 segundos
              setTimeout(() => {
                localStorage.removeItem('adminToken');
                window.location.href = '/login.html';
              }, 3000);
            }
          }
        }
      } catch (e) {
        console.error('Error cargando datos:', e);
        this.showToast('Error al cargar datos. Verifica tu conexi√≥n.', 'error');
      }
      
      this.loading = false;
    },
    
    get rolesFiltrados() {
      return this.roles.filter(r => {
        const matchBusqueda = !this.busqueda || 
          r.nombre?.toLowerCase().includes(this.busqueda.toLowerCase()) ||
          r.nombreDisplay?.toLowerCase().includes(this.busqueda.toLowerCase());
        const matchTipo = !this.filtroTipo || 
          (this.filtroTipo === 'sistema' && r.esSistema) ||
          (this.filtroTipo === 'personalizado' && !r.esSistema);
        return matchBusqueda && matchTipo;
      });
    },
    
    getTopPermisos(permisos, count) {
      if (!permisos || permisos.length === 0) return [];
      return permisos.slice(0, count).map(p => {
        const permiso = this.permisosFundamentales.find(pf => pf.id === p);
        return permiso ? permiso.nombre : p;
      });
    },
    
    getNombrePermiso(permisoId) {
      const permiso = this.permisosFundamentales.find(p => p.id === permisoId);
      return permiso ? permiso.nombre : permisoId;
    },
    
    openCreateModal() {
      this.isEditing = false;
      this.formRol = {
        _id: null,
        nombre: '',
        nombreDisplay: '',
        descripcion: '',
        permisos: [],
        color: 'st-libre',
        esSistema: false
      };
      this.modalEditar = true;
    },
    
    openEditModal(rol) {
      this.isEditing = true;
      this.formRol = {
        _id: rol._id,
        nombre: rol.nombre,
        nombreDisplay: rol.nombreDisplay || rol.nombre,
        descripcion: rol.descripcion || '',
        permisos: [...(rol.permisos || [])],
        color: rol.color || 'st-libre',
        esSistema: rol.esSistema
      };
      this.modalEditar = true;
    },
    
    verPermisos(rol) {
      this.rolDetalle = rol;
      this.modalPermisos = true;
    },
    
    togglePermiso(permisoId) {
      const idx = this.formRol.permisos.indexOf(permisoId);
      if (idx >= 0) {
        this.formRol.permisos.splice(idx, 1);
      } else {
        this.formRol.permisos.push(permisoId);
      }
    },
    
    seleccionarTodosPermisos() {
      this.formRol.permisos = this.permisosFundamentales.map(p => p.id);
    },
    
    async guardarRol() {
      if (!this.formRol.nombreDisplay?.trim()) {
        this.showToast('El nombre del rol es requerido', 'error');
        return;
      }
      
      const body = {
        nombre: this.formRol.nombreDisplay.toLowerCase().replace(/\s+/g, '-'),
        nombreDisplay: this.formRol.nombreDisplay,
        descripcion: this.formRol.descripcion,
        permisos: this.formRol.permisos,
        color: this.formRol.color
      };
      
      let res;
      if (this.isEditing && this.formRol._id) {
        res = await apiPut('/roles/' + this.formRol._id, body);
      } else {
        res = await apiPost('/roles', body);
      }
      
      if (res && res.success) {
        await this.cargarDatos();
        this.modalEditar = false;
        this.showToast(this.isEditing ? 'Rol actualizado correctamente' : 'Rol creado correctamente');
      } else {
        this.showToast('Error: ' + (res?.error || 'No se pudo guardar'), 'error');
      }
    },
    
    async eliminarRol(rol) {
      if (rol.esSistema) {
        this.showToast('Los roles del sistema no se pueden eliminar', 'error');
        return;
      }
      
      if (!confirm(`¬øEliminar el rol "${rol.nombreDisplay || rol.nombre}"?`)) return;
      
      const res = await apiDelete('/roles/' + rol._id);
      
      if (res && res.success) {
        await this.cargarDatos();
        this.showToast('Rol eliminado correctamente');
      } else {
        this.showToast('Error: ' + (res?.error || 'No se pudo eliminar'), 'error');
      }
    },
    
    showToast(msg, type = 'success') {
      const container = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'px-4 py-3 rounded-xl text-sm font-medium shadow-xl ' +
        (type === 'error' ? 'bg-st-pagado text-white' : 'bg-st-preparado text-white');
      t.textContent = msg;
      container.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
  };
}
</script>
</body>
</html>
