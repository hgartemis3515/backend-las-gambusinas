<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî Las Gambusinas</title>
  <!-- Animate.css - Animaciones CSS puras -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- AOS - Animate On Scroll -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
<!-- Alpine.js + Collapse Plugin -->
<script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: { primary: '#0a0a0f', card: '#1a1a28', sidebar: '#12121a' },
        gold: { DEFAULT: '#d4af37', '20': 'rgba(212,175,55,0.125)', '40': 'rgba(212,175,55,0.25)' },
        st: { libre: '#00d4aa', esperando: '#ffa502', pedido: '#3498db', preparado: '#2ecc71', pagado: '#ff4757', reservado: '#5352ed' },
        txt: { primary: '#ffffff', secondary: '#a0a0b8', muted: '#5a5a7a' }
      },
      fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
    }
  }
}
</script>
<link rel="stylesheet" href="/assets/css/dashboard.css">
<link rel="stylesheet" href="/assets/css/animations.css">
<link rel="stylesheet" href="/assets/css/page-transitions.css">
</head>
<body class="bg-bg-primary text-white font-sans antialiased min-h-screen" x-data="dashApp()" x-cloak>

<!-- TOPBAR -->
<div id="topbar-container"></div>

<!-- LAYOUT -->
<div class="flex pt-[72px] min-h-screen">
  <!-- SIDEBAR -->
  <div id="sidebar-container"></div>
  
  <!-- MAIN -->
  <main :class="sidebarOpen ? 'ml-[270px]' : 'ml-[68px]'" class="flex-1 transition-all duration-300 min-h-[calc(100vh-72px)] p-6">
    
    <!-- HEADER -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold" x-text="'Buenas ' + getSaludo() + ', Admin üëã'"></h1>
        <p class="text-txt-muted text-sm mt-1" x-text="getFecha()"></p>
      </div>
      <div class="flex gap-2">
        <button @click="loadDashboard()" class="px-4 py-2 border border-txt-muted/30 rounded-lg text-sm text-txt-secondary hover:border-gold hover:text-gold transition">üîÑ Actualizar</button>
        <button @click="exportarDashboard()" class="px-4 py-2 border border-txt-muted/30 rounded-lg text-sm text-txt-secondary hover:border-gold hover:text-gold transition">üì• Exportar</button>
        <button @click="modal='personalizar'" class="px-4 py-2 border border-gold/40 rounded-lg text-sm text-gold hover:bg-gold-20 transition">‚öôÔ∏è Personalizar</button>
      </div>
    </div>

    <!-- DYNAMIC KPIs ROW -->
    <div x-show="activeKpis.length > 0" class="grid gap-4 mb-6" :style="'grid-template-columns: repeat(' + Math.min(activeKpis.length, 5) + ', 1fr)'">
      <template x-for="w in activeKpis" :key="w.id">
        <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-xl p-4 card-hover">
          <!-- kpi-mesas -->
          <template x-if="w.id === 'kpi-mesas'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Mesas Ocupadas</p>
              <p class="text-2xl font-bold mt-1 text-gold" x-text="kpiMesasOcupadas"></p>
              <p class="text-xs mt-1 text-txt-muted" x-text="kpiOcupacionPct + ' ocupaci√≥n'"></p>
            </div>
          </template>
          <!-- kpi-ventas -->
          <template x-if="w.id === 'kpi-ventas'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Ventas Hoy</p>
              <p class="text-2xl font-bold mt-1 text-gold" x-text="kpiVentasHoy"></p>
              <p class="text-xs mt-1 text-txt-muted" x-text="kpiVentasPct"></p>
            </div>
          </template>
          <!-- kpi-plato -->
          <template x-if="w.id === 'kpi-plato'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Top Plato</p>
              <p class="text-2xl font-bold mt-1 text-white" x-text="kpiTopPlato"></p>
              <p class="text-xs mt-1 text-txt-muted" x-text="kpiTopPlatoSub"></p>
            </div>
          </template>
          <!-- kpi-mozo -->
          <template x-if="w.id === 'kpi-mozo'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Top Mozo</p>
              <p class="text-2xl font-bold mt-1 text-white" x-text="kpiTopMozo"></p>
              <p class="text-xs mt-1 text-txt-muted" x-text="kpiTopMozoSub"></p>
            </div>
          </template>
          <!-- kpi-alertas -->
          <template x-if="w.id === 'kpi-alertas'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Alertas</p>
              <p class="text-2xl font-bold mt-1 text-st-pagado" x-text="kpiAlertas"></p>
              <p class="text-xs mt-1 text-txt-muted" x-text="kpiAlertasSub"></p>
            </div>
          </template>
          <!-- kpi-tiempo -->
          <template x-if="w.id === 'kpi-tiempo'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Tiempo Prom. Cocina</p>
              <p class="text-2xl font-bold mt-1 text-st-esperando" x-text="kpiTiempoCocina"></p>
              <p class="text-xs mt-1 text-txt-muted">promedio hoy</p>
            </div>
          </template>
          <!-- kpi-tickets -->
          <template x-if="w.id === 'kpi-tickets'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Tickets Hoy</p>
              <p class="text-2xl font-bold mt-1 text-st-pedido" x-text="kpiTicketsHoy"></p>
              <p class="text-xs mt-1 text-txt-muted">comandas cerradas</p>
            </div>
          </template>
          <!-- kpi-satisfaccion -->
          <template x-if="w.id === 'kpi-satisfaccion'">
            <div>
              <p class="text-[11px] text-txt-muted uppercase tracking-wide">Satisfacci√≥n</p>
              <p class="text-2xl font-bold mt-1 text-st-preparado">94%</p>
              <p class="text-xs mt-1 text-txt-muted">basado en feedback</p>
            </div>
          </template>
        </div>
      </template>
    </div>

    <!-- DYNAMIC CHARTS ROW -->
    <div x-show="activePanels.length > 0" class="grid grid-cols-12 gap-4 mb-6">
      <template x-for="w in activePanels" :key="w.id">
        <div :class="'col-span-' + getWidgetColSpan(w.id)" class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 flex flex-col" style="min-height: 320px;">

          <!-- mapa-mesas -->
          <template x-if="w.id === 'mapa-mesas'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <h3 class="font-semibold text-sm">Mapa de Mesas</h3>
                <span class="text-[11px] text-txt-muted" x-text="(mesas.length || 0) + ' mesas'"></span>
              </div>
              <div class="flex-1 overflow-auto min-h-0">
                <div x-show="loading && mesas.length === 0" class="flex items-center justify-center h-full">
                  <div class="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
                </div>
                <div x-show="!loading || mesas.length > 0" class="grid grid-cols-5 gap-2">
                  <template x-for="m in (mesas.length > 0 ? mesas : sharedData.mockMesas)" :key="m._id || m.numero">
                    <div class="aspect-square rounded-lg border-2 flex flex-col items-center justify-center text-xs cursor-pointer hover:scale-105 transition"
                      :class="mesaClass(estadoNormalizado(m.estado))" @click="openMesa(m)">
                      <span class="font-bold" x-text="m.numMesa || m.numero"></span>
                      <span class="text-[9px] mt-0.5 opacity-70" x-text="estadoNormalizado(m.estado)"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- grafico-ventas -->
          <template x-if="w.id === 'grafico-ventas'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <h3 class="font-semibold text-sm mb-4 flex-shrink-0">Ventas del D√≠a</h3>
              <div class="relative flex-1 min-h-0">
                <canvas :id="'chartVentasDia'" x-init="$nextTick(() => initChartVentas())"></canvas>
              </div>
            </div>
          </template>

          <!-- grafico-categorias -->
          <template x-if="w.id === 'grafico-categorias'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <h3 class="font-semibold text-sm mb-4 flex-shrink-0">Distribuci√≥n Categor√≠as</h3>
              <div class="relative flex-1 min-h-0">
                <canvas :id="'chartCategorias'" x-init="$nextTick(() => initChartCategorias())"></canvas>
              </div>
            </div>
          </template>

          <!-- grafico-mozos -->
          <template x-if="w.id === 'grafico-mozos'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <h3 class="font-semibold text-sm mb-4 flex-shrink-0">Performance Mozos</h3>
              <div class="relative flex-1 min-h-0">
                <canvas :id="'chartMozos'" x-init="$nextTick(() => initChartMozos())"></canvas>
              </div>
            </div>
          </template>

          <!-- comandas-activas -->
          <template x-if="w.id === 'comandas-activas'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <h3 class="font-semibold text-sm mb-4 flex-shrink-0">Comandas Activas</h3>
              <div class="flex-1 overflow-auto min-h-0 space-y-2">
                <template x-for="c in comandasActivas" :key="c._id || c.id">
                  <div class="flex items-center justify-between text-sm p-2 rounded-lg bg-bg-sidebar">
                    <span class="text-txt-secondary" x-text="'#' + (c.comandaNumber || c._id?.slice(-4) || '‚Äî') + ' ¬∑ Mesa ' + (c.mesa?.numMesa || c.mesa || '‚Äî')"></span>
                    <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                      :class="(c.status||c.estado||'').toLowerCase().includes('preparado') ? 'bg-st-preparado/20 text-st-preparado' : 'bg-st-esperando/20 text-st-esperando'"
                      x-text="c.status || c.estado || '‚Äî'"></span>
                  </div>
                </template>
                <div x-show="comandasActivas.length === 0" class="text-center text-txt-muted text-xs py-8">Sin comandas activas</div>
              </div>
            </div>
          </template>

          <!-- mozos-turno -->
          <template x-if="w.id === 'mozos-turno'">
            <div class="flex flex-col h-full" style="min-height: 280px;">
              <h3 class="font-semibold text-sm mb-4 flex-shrink-0">Mozos en Turno</h3>
              <div class="flex-1 overflow-auto min-h-0 space-y-2">
                <template x-for="mz in mozos.filter(m => m.isActive !== false)" :key="mz._id || mz.id">
                  <div class="flex items-center gap-3 text-sm p-2 rounded-lg bg-bg-sidebar">
                    <span class="w-2 h-2 rounded-full bg-st-preparado flex-shrink-0"></span>
                    <span class="text-txt-secondary" x-text="mz.nombre || mz.name || '‚Äî'"></span>
                    <span class="ml-auto text-xs text-gold" x-text="'S/. ' + (mz.ventasHoy || 0)"></span>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- placeholder for other panel widgets -->
          <template x-if="!['mapa-mesas','grafico-ventas','grafico-categorias','grafico-mozos','comandas-activas','mozos-turno','actividad'].includes(w.id)">
            <div class="flex flex-col h-full items-center justify-center" style="min-height: 280px;">
              <span class="text-3xl mb-2" x-text="getWidgetIcon(w.id)"></span>
              <p class="text-sm text-txt-secondary" x-text="getWidgetNombre(w.id)"></p>
              <p class="text-[10px] text-txt-muted mt-1">Pr√≥ximamente</p>
            </div>
          </template>

        </div>
      </template>
    </div>

    <!-- DYNAMIC FULL-WIDTH WIDGETS -->
    <template x-for="w in activeFullWidgets" :key="w.id">
      <div class="mb-6">
        <!-- actividad -->
        <template x-if="w.id === 'actividad'">
          <div class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5">
            <h3 class="font-semibold text-sm mb-4">Actividad Reciente</h3>
            <div class="space-y-3">
              <template x-for="a in activity" :key="a.timestamp || a.text">
                <div class="flex items-center gap-3 text-sm">
                  <span class="w-2 h-2 rounded-full flex-shrink-0" :class="a.dotClass"></span>
                  <span class="text-txt-secondary" x-text="a.text"></span>
                  <span class="ml-auto text-xs text-txt-muted" x-text="a.time"></span>
                </div>
              </template>
              <div x-show="activity.length === 0" class="text-center text-txt-muted text-xs py-6">
                Sin actividad reciente
              </div>
            </div>
          </div>
        </template>
        <!-- top-platos -->
        <template x-if="w.id === 'top-platos'">
          <div class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5">
            <h3 class="font-semibold text-sm mb-4">Top 10 Platos</h3>
            <div class="space-y-2">
              <template x-for="(p, i) in topPlatosData" :key="p.nombre">
                <div class="flex items-center gap-3 text-sm">
                  <span class="w-6 text-center text-xs text-txt-muted font-bold" x-text="i + 1"></span>
                  <span class="flex-1 text-txt-secondary" x-text="p.nombre"></span>
                  <span class="text-xs text-gold font-semibold" x-text="p.cantidad + ' vendidos'"></span>
                </div>
              </template>
              <div x-show="topPlatosData.length === 0" class="text-center text-txt-muted text-xs py-4">Sin datos de platos</div>
            </div>
          </div>
        </template>
        <!-- placeholder full-width -->
        <template x-if="!['actividad','top-platos'].includes(w.id)">
          <div class="bg-bg-card border border-[rgba(212,175,55,0.15)] rounded-xl p-5 text-center py-8">
            <span class="text-2xl" x-text="getWidgetIcon(w.id)"></span>
            <p class="text-sm text-txt-secondary mt-2" x-text="getWidgetNombre(w.id)"></p>
            <p class="text-[10px] text-txt-muted mt-1">Pr√≥ximamente</p>
          </div>
        </template>
      </div>
    </template>

    <!-- Empty state when no widgets -->
    <div x-show="activeKpis.length === 0 && activePanels.length === 0 && activeFullWidgets.length === 0"
      class="flex flex-col items-center justify-center py-20 text-center">
      <p class="text-4xl mb-4">üìä</p>
      <p class="text-lg font-semibold text-txt-secondary">No hay widgets activos</p>
      <p class="text-sm text-txt-muted mt-1 mb-4">Usa el bot√≥n Personalizar para agregar widgets a tu dashboard</p>
      <button @click="modal='personalizar'" class="px-4 py-2 bg-gold text-bg-primary rounded-lg text-sm font-semibold hover:brightness-110">‚öôÔ∏è Personalizar Dashboard</button>
    </div>

  </main>
</div>

<!-- MODAL: DETALLE MESA -->
<div x-show="modal==='detalleMesa'" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay bg-black/70" @click.self="modal=null">
  <div class="bg-bg-card border border-[rgba(212,175,55,0.25)] rounded-2xl w-[420px] shadow-2xl" @click.stop>
    <div class="p-5 border-b border-[rgba(212,175,55,0.1)]">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold" x-text="selectedMesa ? 'Mesa ' + (selectedMesa.numMesa || selectedMesa.numero) : ''"></h2>
        <button @click="modal=null" class="w-7 h-7 flex items-center justify-center rounded-full bg-gold-20 text-gold text-sm hover:bg-gold/30">‚úï</button>
      </div>
      <p class="text-xs text-txt-muted mt-1" x-text="selectedMesa ? '√Årea: ' + (selectedMesa.area?.nombre || selectedMesa.area || '‚Äî') : ''"></p>
    </div>
    <div class="p-5">
      <div class="flex items-center justify-between mb-4">
        <span class="text-xs px-2.5 py-1 rounded-full font-semibold" :class="selectedMesa && mesaBadge(estadoNormalizado(selectedMesa?.estado))" x-text="estadoNormalizado(selectedMesa?.estado)"></span>
        <span class="text-xs text-txt-muted" x-show="selectedMesa?.idMozo" x-text="'üë§ ' + (selectedMesa?.idMozo?.nombre || selectedMesa?.mozo || '‚Äî')"></span>
      </div>
      <p class="text-[11px] text-txt-muted uppercase mb-2">Informaci√≥n</p>
      <div class="space-y-2 mb-4">
        <div class="flex justify-between text-sm"><span>Capacidad</span><span class="text-txt-secondary" x-text="selectedMesa?.capacidad || '‚Äî'"></span></div>
        <div class="flex justify-between text-sm"><span>Personas</span><span class="text-txt-secondary" x-text="selectedMesa?.personas || '‚Äî'"></span></div>
      </div>
      <div class="border-t border-[rgba(212,175,55,0.15)] pt-3 flex justify-between">
        <span class="font-semibold">Monto Actual</span>
        <span class="text-gold text-lg font-bold" x-text="selectedMesa?.monto ? 'S/. ' + selectedMesa.monto : 'S/. ‚Äî'"></span>
      </div>
    </div>
    <div class="flex gap-2 p-5 pt-0">
      <button @click="liberarMesa()" class="flex-1 py-2.5 border border-st-pagado text-st-pagado rounded-lg text-sm font-medium hover:bg-st-pagado/10">Liberar Mesa</button>
      <a :href="'/comandas.html?mesa=' + (selectedMesa?._id || '')" class="flex-1 py-2.5 bg-gold text-bg-primary rounded-lg text-sm font-semibold hover:brightness-110 text-center">Ver Comanda</a>
    </div>
  </div>
</div>

<!-- MODAL: PERSONALIZAR DASHBOARD -->
<div x-show="modal==='personalizar'" x-transition.opacity class="fixed inset-0 z-50 flex modal-overlay bg-black/85" @click.self="modal=null" x-data="personalizarApp()">
  <!-- Dashboard Ghost (izquierda) -->
  <div class="flex-1 relative opacity-30 pointer-events-none">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="text-center">
        <p class="text-txt-muted text-sm">Vista previa del dashboard</p>
        <p class="text-txt-muted text-xs mt-1">Los widgets se muestran como referencia</p>
      </div>
    </div>
  </div>

  <!-- Panel Lateral (derecha) -->
  <div class="w-[500px] bg-bg-card border-l border-[rgba(212,175,55,0.25)] flex flex-col h-full" @click.stop>
    <!-- Header -->
    <div class="p-5 border-b border-[rgba(212,175,55,0.15)] flex items-center justify-between">
      <h2 class="text-lg font-bold">Personalizar Dashboard</h2>
      <button @click="modal=null" class="w-8 h-8 flex items-center justify-center rounded-full bg-gold-20 text-gold text-sm hover:bg-gold/30">‚úï</button>
    </div>

    <!-- Tabs -->
    <div class="flex border-b border-[rgba(212,175,55,0.15)]">
      <button @click="persTab='agregar'" :class="persTab==='agregar' ? 'text-gold border-b-2 border-gold' : 'text-txt-secondary'" class="px-5 py-3 text-sm font-medium transition">Agregar Widgets</button>
      <button @click="persTab='activos'" :class="persTab==='activos' ? 'text-gold border-b-2 border-gold' : 'text-txt-secondary'" class="px-5 py-3 text-sm font-medium transition">Widgets Activos</button>
      <button @click="persTab='layouts'" :class="persTab==='layouts' ? 'text-gold border-b-2 border-gold' : 'text-txt-secondary'" class="px-5 py-3 text-sm font-medium transition">Layouts Guardados</button>
    </div>

    <!-- Contenido: Agregar Widgets -->
    <div x-show="persTab==='agregar'" class="flex-1 overflow-y-auto p-4">
      <!-- Buscador -->
      <input type="text" x-model="widgetSearch" placeholder="üîç Buscar widget..." class="w-full bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg px-4 py-2.5 text-sm mb-4 focus:border-gold focus:outline-none">

      <!-- Categor√≠a: M√©tricas -->
      <div class="mb-4">
        <button @click="catMetricas=!catMetricas" class="flex items-center justify-between w-full py-2 text-sm font-semibold text-txt-secondary">
          <span x-text="'üìä M√©tricas (' + filteredWidgets(widgetsMetricas).length + ' widgets)'"></span>
          <span x-text="catMetricas ? '‚ñº' : '‚ñ∂'" class="text-xs"></span>
        </button>
        <div x-show="catMetricas" x-collapse class="grid grid-cols-2 gap-2 mt-2">
          <template x-for="w in filteredWidgets(widgetsMetricas)" :key="w.id">
            <div class="bg-bg-sidebar border rounded-xl p-3 transition hover:border-gold/40" :class="isWidgetActive(w.id) ? 'border-st-preparado' : 'border-[rgba(212,175,55,0.15)]'">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl" x-text="w.icon"></span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium truncate" x-text="w.nombre"></p>
                  <p class="text-[10px] text-txt-muted" x-text="w.tamano"></p>
                </div>
              </div>
              <template x-if="isWidgetActive(w.id)">
                <span class="text-[10px] px-2 py-1 rounded-full bg-st-preparado/20 text-st-preparado font-semibold">Activo</span>
              </template>
              <template x-if="!isWidgetActive(w.id)">
                <button @click="addWidget(w)" class="text-[10px] px-3 py-1.5 rounded-lg bg-gold text-bg-primary font-semibold hover:brightness-110">+ A√±adir</button>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Categor√≠a: Gr√°ficos -->
      <div class="mb-4">
        <button @click="catGraficos=!catGraficos" class="flex items-center justify-between w-full py-2 text-sm font-semibold text-txt-secondary">
          <span x-text="'üìà Gr√°ficos (' + filteredWidgets(widgetsGraficos).length + ' widgets)'"></span>
          <span x-text="catGraficos ? '‚ñº' : '‚ñ∂'" class="text-xs"></span>
        </button>
        <div x-show="catGraficos" x-collapse class="grid grid-cols-2 gap-2 mt-2">
          <template x-for="w in filteredWidgets(widgetsGraficos)" :key="w.id">
            <div class="bg-bg-sidebar border rounded-xl p-3 transition hover:border-gold/40" :class="isWidgetActive(w.id) ? 'border-st-preparado' : 'border-[rgba(212,175,55,0.15)]'">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl" x-text="w.icon"></span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium truncate" x-text="w.nombre"></p>
                  <p class="text-[10px] text-txt-muted" x-text="w.tamano"></p>
                </div>
              </div>
              <template x-if="isWidgetActive(w.id)">
                <span class="text-[10px] px-2 py-1 rounded-full bg-st-preparado/20 text-st-preparado font-semibold">Activo</span>
              </template>
              <template x-if="!isWidgetActive(w.id)">
                <button @click="addWidget(w)" class="text-[10px] px-3 py-1.5 rounded-lg bg-gold text-bg-primary font-semibold hover:brightness-110">+ A√±adir</button>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Categor√≠a: Operaciones (colapsada por defecto) -->
      <div class="mb-4">
        <button @click="catOperaciones=!catOperaciones" class="flex items-center justify-between w-full py-2 text-sm font-semibold text-txt-secondary">
          <span x-text="'‚öôÔ∏è Operaciones (' + filteredWidgets(widgetsOperaciones).length + ' widgets)'"></span>
          <span x-text="catOperaciones ? '‚ñº' : '‚ñ∂'" class="text-xs"></span>
        </button>
        <div x-show="catOperaciones" x-collapse class="grid grid-cols-2 gap-2 mt-2">
          <template x-for="w in filteredWidgets(widgetsOperaciones)" :key="w.id">
            <div class="bg-bg-sidebar border rounded-xl p-3 transition hover:border-gold/40" :class="isWidgetActive(w.id) ? 'border-st-preparado' : 'border-[rgba(212,175,55,0.15)]'">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl" x-text="w.icon"></span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium truncate" x-text="w.nombre"></p>
                  <p class="text-[10px] text-txt-muted" x-text="w.tamano"></p>
                </div>
              </div>
              <template x-if="isWidgetActive(w.id)">
                <span class="text-[10px] px-2 py-1 rounded-full bg-st-preparado/20 text-st-preparado font-semibold">Activo</span>
              </template>
              <template x-if="!isWidgetActive(w.id)">
                <button @click="addWidget(w)" class="text-[10px] px-3 py-1.5 rounded-lg bg-gold text-bg-primary font-semibold hover:brightness-110">+ A√±adir</button>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- Categor√≠a: An√°lisis (colapsada por defecto) -->
      <div class="mb-4">
        <button @click="catAnalisis=!catAnalisis" class="flex items-center justify-between w-full py-2 text-sm font-semibold text-txt-secondary">
          <span x-text="'üß† An√°lisis (' + filteredWidgets(widgetsAnalisis).length + ' widgets)'"></span>
          <span x-text="catAnalisis ? '‚ñº' : '‚ñ∂'" class="text-xs"></span>
        </button>
        <div x-show="catAnalisis" x-collapse class="grid grid-cols-2 gap-2 mt-2">
          <template x-for="w in filteredWidgets(widgetsAnalisis)" :key="w.id">
            <div class="bg-bg-sidebar border rounded-xl p-3 transition hover:border-gold/40" :class="isWidgetActive(w.id) ? 'border-st-preparado' : 'border-[rgba(212,175,55,0.15)]'">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl" x-text="w.icon"></span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium truncate" x-text="w.nombre"></p>
                  <p class="text-[10px] text-txt-muted" x-text="w.tamano"></p>
                </div>
              </div>
              <template x-if="isWidgetActive(w.id)">
                <span class="text-[10px] px-2 py-1 rounded-full bg-st-preparado/20 text-st-preparado font-semibold">Activo</span>
              </template>
              <template x-if="!isWidgetActive(w.id)">
                <button @click="addWidget(w)" class="text-[10px] px-3 py-1.5 rounded-lg bg-gold text-bg-primary font-semibold hover:brightness-110">+ A√±adir</button>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Contenido: Widgets Activos -->
    <div x-show="persTab==='activos'" class="flex-1 overflow-y-auto p-4">
      <p class="text-xs text-txt-muted mb-3">Arrastra para reordenar. <span x-text="activeWidgets.length"></span> widgets activos.</p>
      <div class="space-y-2" id="sortable-widgets">
        <template x-for="(w, idx) in activeWidgets" :key="w.id">
          <div class="bg-bg-sidebar border border-[rgba(212,175,55,0.25)] rounded-lg p-3 flex items-center gap-2 group"
            draggable="true"
            @dragstart="dragStart($event, idx)"
            @dragover.prevent="dragOver($event, idx)"
            @dragend="dragEnd()"
            :class="dragIdx === idx ? 'opacity-40 border-gold' : ''">
            <!-- Drag handle -->
            <span class="text-txt-muted cursor-grab active:cursor-grabbing text-xs select-none mr-1" title="Arrastrar">‚†ø</span>
            <span class="text-lg" x-text="w.icon"></span>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium truncate" x-text="w.nombre"></p>
              <p class="text-[10px] text-txt-muted" x-text="w.tamano"></p>
            </div>
            <!-- Move buttons -->
            <button @click="moveWidget(idx, -1)" :disabled="idx === 0" class="w-6 h-6 flex items-center justify-center rounded text-xs transition" :class="idx === 0 ? 'text-txt-muted/30' : 'text-txt-muted hover:text-gold hover:bg-gold-20'">‚ñ≤</button>
            <button @click="moveWidget(idx, 1)" :disabled="idx === activeWidgets.length - 1" class="w-6 h-6 flex items-center justify-center rounded text-xs transition" :class="idx === activeWidgets.length - 1 ? 'text-txt-muted/30' : 'text-txt-muted hover:text-gold hover:bg-gold-20'">‚ñº</button>
            <button @click="removeWidget(w.id)" class="w-7 h-7 flex items-center justify-center rounded bg-st-pagado/20 text-st-pagado text-xs hover:bg-st-pagado/30">‚úï</button>
          </div>
        </template>
      </div>
    </div>

    <!-- Contenido: Layouts Guardados -->
    <div x-show="persTab==='layouts'" class="flex-1 overflow-y-auto p-4">
      <p class="text-xs text-txt-muted mb-3">Selecciona un layout para aplicarlo:</p>
      <div class="space-y-2">
        <template x-for="preset in layoutPresets" :key="preset.name">
          <div @click="applyPreset(preset)"
            class="bg-bg-sidebar border rounded-lg p-3 cursor-pointer transition hover:border-gold/40"
            :class="currentPresetName === preset.name ? 'border-gold/40' : 'border-[rgba(212,175,55,0.25)]'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium" :class="currentPresetName === preset.name ? 'text-gold' : ''" x-text="preset.icon + ' ' + preset.name"></p>
                <p class="text-[10px] text-txt-muted" x-text="preset.desc"></p>
              </div>
              <span x-show="currentPresetName === preset.name" class="text-[10px] px-2 py-1 rounded-full bg-gold/20 text-gold">Actual</span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-[rgba(212,175,55,0.15)] flex items-center justify-between">
      <button @click="restoreDefaults()" class="px-4 py-2 text-sm text-txt-muted hover:text-white transition">Restaurar predeterminados</button>
      <div class="flex gap-2">
        <button @click="modal=null" class="px-4 py-2 border border-gold/40 rounded-lg text-sm text-gold hover:bg-gold-20 transition">Cerrar</button>
        <button @click="saveLayout()" class="px-4 py-2 bg-gold text-bg-primary rounded-lg text-sm font-semibold hover:brightness-110 transition">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed bottom-6 right-6 z-[9999] space-y-2"></div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="/assets/js/shared.js"></script>
<script src="/assets/js/charts.js"></script>
<script>
// ============================================
// WIDGET CATALOG ‚Äî Single source of truth
// ============================================
const WIDGET_CATALOG = {
  'kpi-mesas':          { icon: 'ü™ë', nombre: 'Mesas Ocupadas',         tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-ventas':         { icon: 'üí∞', nombre: 'Ventas del D√≠a',         tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-plato':          { icon: 'üçΩÔ∏è', nombre: 'Top Plato',             tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-mozo':           { icon: 'üë§', nombre: 'Top Mozo',               tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-alertas':        { icon: 'üî¥', nombre: 'Alertas',                tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-tiempo':         { icon: '‚è∞', nombre: 'Tiempo Prom. Cocina',    tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-tickets':        { icon: 'üßæ', nombre: 'Tickets Hoy',            tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'kpi-satisfaccion':   { icon: '‚≠ê', nombre: 'Satisfacci√≥n',           tamano: '1 col ¬∑ M√©trica',    tipo: 'kpi',   colSpan: 1 },
  'mapa-mesas':         { icon: 'üó∫Ô∏è', nombre: 'Mapa de Mesas',         tamano: '7 cols ¬∑ Visual',    tipo: 'panel', colSpan: 7 },
  'grafico-ventas':     { icon: 'üìà', nombre: 'Ventas por Hora',        tamano: '5 cols ¬∑ Gr√°fico',   tipo: 'panel', colSpan: 5 },
  'grafico-categorias': { icon: 'ü•ß', nombre: 'Distribuci√≥n Categor√≠as',tamano: '4 cols ¬∑ Donut',    tipo: 'panel', colSpan: 4 },
  'grafico-mozos':      { icon: 'üìä', nombre: 'Performance Mozos',      tamano: '6 cols ¬∑ Barras',    tipo: 'panel', colSpan: 6 },
  'grafico-mesas':      { icon: 'üó∫Ô∏è', nombre: 'Ocupaci√≥n por Mesa',    tamano: '6 cols ¬∑ Heatmap',   tipo: 'panel', colSpan: 6 },
  'grafico-semanal':    { icon: 'üìâ', nombre: 'Ventas Semanales',       tamano: '6 cols ¬∑ √Årea',      tipo: 'panel', colSpan: 6 },
  'grafico-historico':  { icon: 'üìà', nombre: 'Tendencia Mensual',      tamano: '8 cols ¬∑ L√≠nea',     tipo: 'panel', colSpan: 8 },
  'grafico-propinas':   { icon: 'üíµ', nombre: 'Propinas por D√≠a',       tamano: '4 cols ¬∑ Barras',    tipo: 'panel', colSpan: 4 },
  'grafico-tiempos':    { icon: '‚è±Ô∏è', nombre: 'Tiempos de Servicio',   tamano: '4 cols ¬∑ Barras',    tipo: 'panel', colSpan: 4 },
  'actividad':          { icon: 'üìã', nombre: 'Actividad Reciente',     tamano: '12 cols ¬∑ Lista',    tipo: 'full',  colSpan: 12 },
  'comandas-activas':   { icon: 'üç≥', nombre: 'Comandas Activas',       tamano: '4 cols ¬∑ Lista',     tipo: 'panel', colSpan: 4 },
  'pedidos-listos':     { icon: '‚úÖ', nombre: 'Pedidos Listos',          tamano: '3 cols ¬∑ Lista',     tipo: 'panel', colSpan: 3 },
  'stock-bajo':         { icon: '‚ö†Ô∏è', nombre: 'Alertas Stock',          tamano: '3 cols ¬∑ Tabla',     tipo: 'panel', colSpan: 3 },
  'mozos-turno':        { icon: 'üë•', nombre: 'Mozos en Turno',          tamano: '4 cols ¬∑ Tarjetas',  tipo: 'panel', colSpan: 4 },
  'top-platos':         { icon: 'üèÜ', nombre: 'Top 10 Platos',          tamano: '12 cols ¬∑ Tabla',    tipo: 'full',  colSpan: 12 },
  'clientes-frecuentes':{ icon: 'üíé', nombre: 'Clientes Frecuentes',    tamano: '4 cols ¬∑ Lista',     tipo: 'panel', colSpan: 4 },
  'hora-pico':          { icon: 'üïê', nombre: 'An√°lisis Hora Pico',     tamano: '4 cols ¬∑ Tarjeta',   tipo: 'panel', colSpan: 4 },
  'comparativo':        { icon: 'üìä', nombre: 'Comparativo',             tamano: '6 cols ¬∑ Tarjetas',  tipo: 'panel', colSpan: 6 }
};

const DEFAULT_LAYOUT = [
  'kpi-mesas','kpi-ventas','kpi-plato','kpi-mozo','kpi-alertas',
  'mapa-mesas','grafico-ventas','actividad'
];

const LAYOUT_PRESETS = [
  { name: 'Predeterminado', icon: 'üîß', desc: '5 KPIs, Mapa mesas, Gr√°fico ventas, Actividad',
    widgets: ['kpi-mesas','kpi-ventas','kpi-plato','kpi-mozo','kpi-alertas','mapa-mesas','grafico-ventas','actividad'] },
  { name: 'Ejecutivo', icon: 'üìä', desc: 'KPIs extendidos, gr√°ficos detallados, top platos',
    widgets: ['kpi-mesas','kpi-ventas','kpi-plato','kpi-mozo','kpi-alertas','kpi-tickets','kpi-tiempo','grafico-ventas','grafico-categorias','grafico-mozos','top-platos'] },
  { name: 'Operativo', icon: 'üéØ', desc: 'Mesas, comandas activas, mozos en turno, actividad',
    widgets: ['kpi-mesas','kpi-alertas','kpi-tiempo','mapa-mesas','comandas-activas','mozos-turno','actividad'] },
  { name: 'Minimalista', icon: '‚ú®', desc: 'Solo KPIs y actividad reciente',
    widgets: ['kpi-mesas','kpi-ventas','kpi-alertas','actividad'] }
];

// ============================================
// MAIN DASHBOARD APP
// ============================================
function dashApp() {
  return {
    sidebarOpen: true,
    modal: null,
    selectedMesa: null,
    activeNav: 'dashboard',
    pageTitle: 'Dashboard',
    loading: true,
    mesas: [],
    mozos: [],
    comandasActivas: [],
    topPlatosData: [],
    // KPI data
    kpiMesasOcupadas: '‚Äî',
    kpiOcupacionPct: '‚Äî',
    kpiVentasHoy: 'S/. ‚Äî',
    kpiVentasPct: '+0% vs ayer',
    kpiTopPlato: '‚Äî',
    kpiTopPlatoSub: '‚Äî',
    kpiTopMozo: '‚Äî',
    kpiTopMozoSub: 'Mejor rendimiento',
    kpiAlertas: '0',
    kpiAlertasSub: 'Sin alertas',
    kpiTiempoCocina: '‚Äî',
    kpiTicketsHoy: '0',
    activity: [],
    socket: null,
    // Widget layout
    dashboardLayout: [],
    _ventasLabelsCache: [],
    _ventasDataCache: [],

    // Computed: split layout into rows
    get activeKpis() {
      return this.dashboardLayout.filter(id => WIDGET_CATALOG[id]?.tipo === 'kpi').map(id => ({ id }));
    },
    get activePanels() {
      return this.dashboardLayout
        .filter(id => WIDGET_CATALOG[id]?.tipo === 'panel')
        .map(id => ({ id }));
    },
    get activeFullWidgets() {
      return this.dashboardLayout
        .filter(id => WIDGET_CATALOG[id]?.tipo === 'full')
        .map(id => ({ id }));
    },

    getWidgetColSpan(id) { return WIDGET_CATALOG[id]?.colSpan || 6; },
    getWidgetIcon(id)    { return WIDGET_CATALOG[id]?.icon || 'üì¶'; },
    getWidgetNombre(id)  { return WIDGET_CATALOG[id]?.nombre || id; },

    async init() {
      // Verificar token en ambos storages
      const token = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
      if (!token) { window.location.href = '/login.html'; return; }

      // Load saved layout
      this.loadLayoutFromStorage();

      // Listen for layout changes from the personalizar modal
      this.$el.addEventListener('layout-updated', (e) => {
        this.dashboardLayout = [...e.detail.layout];
        this.saveLayoutToStorage();
        // Re-init charts after DOM settles
        this.$nextTick(() => { this.reinitCharts(); });
      });

      await this.loadDashboard();
      this.initSocket();
      this.startAutoRefresh();
    },

    loadLayoutFromStorage() {
      try {
        const saved = localStorage.getItem('dashboardLayout');
        if (saved) {
          const parsed = JSON.parse(saved);
          const ids = parsed.widgets || parsed;
          if (Array.isArray(ids) && ids.length > 0) {
            // Support both formats: array of strings or array of objects
            this.dashboardLayout = ids.map(w => typeof w === 'string' ? w : w.id).filter(id => WIDGET_CATALOG[id]);
            return;
          }
        }
      } catch (e) { /* ignore */ }
      this.dashboardLayout = [...DEFAULT_LAYOUT];
    },

    saveLayoutToStorage() {
      localStorage.setItem('dashboardLayout', JSON.stringify({ widgets: this.dashboardLayout, savedAt: new Date().toISOString() }));
    },

    isWidgetActive(id) { return this.dashboardLayout.includes(id); },

    async loadDashboard() {
      this.loading = true;
      const hoy = new Date().toISOString().split('T')[0];
      const needs = (id) => this.dashboardLayout.includes(id);

      try {
        // Always fetch mesas and mozos (used by multiple widgets)
        const fetches = [
          apiGet('/mesas'),
          apiGet('/mozos')
        ];
        // Conditionally fetch based on active widgets
        const needsComandas = needs('comandas-activas') || needs('actividad') || needs('kpi-tickets');
        const needsVentas = needs('kpi-ventas') || needs('grafico-ventas');
        const needsAuditoria = needs('actividad');
        const needsTopPlatos = needs('kpi-plato') || needs('top-platos');

        fetches.push(needsComandas ? apiGet('/comandas') : Promise.resolve(null));
        fetches.push(needsVentas ? apiGet('/reportes/ventas?fechaInicio=' + hoy + '&fechaFin=' + hoy + '&agruparPor=hora') : Promise.resolve(null));
        fetches.push(needsAuditoria ? apiGet('/auditoria/comandas?limit=6').catch(() => null) : Promise.resolve(null));
        fetches.push(needsTopPlatos ? apiGet('/reportes/platos-top').catch(() => null) : Promise.resolve(null));

        const [mesas, mozos, comandas, reporteHoy, auditoria, topPlatos] = await Promise.all(fetches);

        // --- MESAS ---
        if (mesas && Array.isArray(mesas)) {
          this.mesas = mesas;
          const ocupadas = mesas.filter(m => m.estado !== 'libre' && m.estado !== 'Libre').length;
          this.kpiMesasOcupadas = ocupadas + '/' + mesas.length;
          this.kpiOcupacionPct = mesas.length > 0 ? Math.round((ocupadas / mesas.length) * 100) + '%' : '0%';
          // Alertas: mesas pagadas sin liberar
          const alertas = mesas.filter(m => (m.estado || '').toLowerCase() === 'pagado');
          this.kpiAlertas = String(alertas.length);
          this.kpiAlertasSub = alertas.length > 0 ? 'Mesa ' + (alertas[0].numMesa || alertas[0].nummesa || '?') + ' sin liberar' : 'Sin alertas';
        }

        // --- MOZOS ---
        if (mozos && Array.isArray(mozos)) {
          this.mozos = mozos;
          const sorted = [...mozos].sort((a, b) => (b.ventasHoy || 0) - (a.ventasHoy || 0));
          const topMozo = sorted[0];
          if (topMozo && (topMozo.nombre || topMozo.name)) {
            const nombre = topMozo.nombre || topMozo.name;
            const partes = nombre.split(' ');
            this.kpiTopMozo = partes[0] + (partes[1] ? ' ' + partes[1].charAt(0) + '.' : '');
            this.kpiTopMozoSub = 'S/. ' + (topMozo.ventasHoy || 0);
          }
        }

        // --- COMANDAS ---
        if (comandas && Array.isArray(comandas)) {
          this.comandasActivas = comandas.filter(c => {
            const st = (c.status || c.estado || '').toLowerCase();
            return !st.includes('entregado') && !st.includes('cancelado');
          }).slice(0, 8);
          this.kpiTicketsHoy = String(comandas.length);
        }

        // --- VENTAS ---
        if (reporteHoy && reporteHoy.data && reporteHoy.data.length > 0) {
          const totalHoy = reporteHoy.data.reduce((s, d) => s + (d.total || 0), 0);
          this.kpiVentasHoy = 'S/. ' + totalHoy.toLocaleString('es-PE');
          this._ventasDataCache = reporteHoy.data.map(d => d.total || 0);
          this._ventasLabelsCache = reporteHoy.data.map(d => d._id || d.hora || '');
          this.initChartVentas();
        } else {
          this.kpiVentasHoy = 'S/. 0';
          this._ventasDataCache = [];
          this._ventasLabelsCache = [];
          if (needs('grafico-ventas')) {
            LasGambusinasCharts.drawEmptyChart('chartVentasDia', 'Sin ventas registradas hoy');
          }
        }

        // --- TOP PLATOS ---
        if (topPlatos && Array.isArray(topPlatos) && topPlatos.length > 0) {
          this.topPlatosData = topPlatos.slice(0, 10);
          const top = topPlatos[0];
          this.kpiTopPlato = top.nombre || top._id || '‚Äî';
          this.kpiTopPlatoSub = (top.cantidad || top.total || 0) + ' vendidos';
        } else {
          this.kpiTopPlato = '‚Äî';
          this.kpiTopPlatoSub = 'sin datos';
        }

        // --- AUDITORIA / ACTIVIDAD ---
        if (auditoria && auditoria.auditorias && Array.isArray(auditoria.auditorias) && auditoria.auditorias.length > 0) {
          this.activity = auditoria.auditorias.slice(0, 6).map(a => {
            const usuarioNombre = a.usuario?.name || a.usuario?.nombre || 'Sistema';
            const comandaNum = a.entidadId?.toString()?.slice(-4) || a.comandaNum || '';
            const hora = a.timestamp ? new Date(a.timestamp) : null;
            return {
              text: (a.accion || 'Acci√≥n') + ' ‚Äî ' + (a.entidadTipo || '') + (comandaNum ? ' #' + comandaNum : '') + (a.detalles?.mesaNum ? ' (Mesa ' + a.detalles.mesaNum + ')' : ''),
              time: hora ? this.timeAgo(hora) : '‚Äî',
              timestamp: hora ? hora.getTime() : Date.now(),
              dotClass: this.getDotClassForAction(a.accion)
            };
          });
        } else if (comandas && Array.isArray(comandas) && comandas.length > 0) {
          this.activity = comandas.slice(0, 6).map(c => {
            let dotClass = 'bg-gold';
            let estado = (c.status || c.estado || '').toLowerCase();
            if (estado.includes('preparado') || estado.includes('listo')) dotClass = 'bg-st-preparado';
            else if (estado.includes('cocina') || estado.includes('pedido')) dotClass = 'bg-st-pedido';
            else if (estado.includes('entregado')) dotClass = 'bg-st-esperando';
            return {
              text: 'Mesa ' + (c.mesa?.numMesa || c.mesa || '‚Äî') + ' ‚Äî Comanda #' + (c.comandaNumber || c._id?.slice(-4) || '‚Äî'),
              time: c.createdAt ? this.timeAgo(new Date(c.createdAt)) : '‚Äî',
              timestamp: c.createdAt ? new Date(c.createdAt).getTime() : Date.now(),
              dotClass
            };
          });
        }

      } catch (e) {
        console.error('Error loading dashboard:', e);
      }

      this.loading = false;
    },

    // Chart init functions (called by x-init on canvas elements)
    initChartVentas() {
      if (this._ventasDataCache.length > 0) {
        LasGambusinasCharts.drawDashChartWithData('chartVentasDia', this._ventasLabelsCache, this._ventasDataCache);
      } else {
        LasGambusinasCharts.drawEmptyChart('chartVentasDia', 'Sin ventas registradas hoy');
      }
    },
    initChartCategorias() {
      LasGambusinasCharts.drawReportDonutChart('chartCategorias');
    },
    initChartMozos() {
      const el = document.getElementById('chartMozos');
      if (!el) return;
      if (el._chart) el._chart.destroy();
      const nombres = this.mozos.slice(0, 5).map(m => (m.nombre || m.name || '‚Äî').split(' ')[0]);
      const ventas = this.mozos.slice(0, 5).map(m => m.ventasHoy || 0);
      el._chart = new Chart(el.getContext('2d'), {
        type: 'bar',
        data: { labels: nombres.length ? nombres : ['‚Äî'], datasets: [{ label: 'Ventas', data: ventas.length ? ventas : [0], backgroundColor: '#d4af37', borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: { x: { ticks: { color: '#a0a0b8', font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { color: '#a0a0b8', font: { size: 10 }, callback: v => 'S/.' + v }, grid: { color: 'rgba(212,175,55,0.06)' } } } }
      });
    },
    reinitCharts() {
      if (this.dashboardLayout.includes('grafico-ventas')) {
        this.$nextTick(() => this.initChartVentas());
      }
      if (this.dashboardLayout.includes('grafico-categorias')) {
        this.$nextTick(() => this.initChartCategorias());
      }
      if (this.dashboardLayout.includes('grafico-mozos')) {
        this.$nextTick(() => this.initChartMozos());
      }
    },

    getDotClassForAction(accion) {
      const a = (accion || '').toLowerCase();
      if (a.includes('eliminado') || a.includes('eliminada')) return 'bg-st-pagado';
      if (a.includes('pago') || a.includes('pagado')) return 'bg-st-pagado';
      if (a.includes('preparado') || a.includes('listo')) return 'bg-st-preparado';
      if (a.includes('creado') || a.includes('nueva')) return 'bg-gold';
      if (a.includes('editado') || a.includes('modificado')) return 'bg-st-esperando';
      return 'bg-st-pedido';
    },

    initSocket() {
      const token = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
      if (!token || typeof io === 'undefined') return;
      try {
        this.socket = io('/admin', { auth: { token }, transports: ['websocket', 'polling'] });

        this.socket.on('mesa:actualizada', (data) => {
          const idx = this.mesas.findIndex(m => m._id === data._id || m._id === data.id);
          if (idx >= 0) this.mesas[idx] = { ...this.mesas[idx], ...data };
          // Recalculate KPIs
          const ocupadas = this.mesas.filter(m => m.estado !== 'libre' && m.estado !== 'Libre').length;
          this.kpiMesasOcupadas = ocupadas + '/' + this.mesas.length;
          this.kpiOcupacionPct = this.mesas.length > 0 ? Math.round((ocupadas / this.mesas.length) * 100) + '%' : '0%';
          const alertas = this.mesas.filter(m => (m.estado || '').toLowerCase() === 'pagado');
          this.kpiAlertas = String(alertas.length);
          this.kpiAlertasSub = alertas.length > 0 ? 'Mesa ' + (alertas[0].numMesa || alertas[0].nummesa || '?') + ' sin liberar' : 'Sin alertas';
          this.addActivity({ text: 'Mesa ' + (data.numMesa || data.numero || '‚Äî') + ' ‚Äî Estado: ' + this.estadoNormalizado(data.estado), dotClass: 'bg-st-libre' });
        });

        this.socket.on('reportes:comanda-nueva', (data) => {
          const comanda = data.comanda || data;
          this.addActivity({ text: 'Mesa ' + (comanda.mesa?.numMesa || data.mesaNum || '‚Äî') + ' ‚Äî Nueva comanda #' + (comanda.comandaNumber || data.comandaNumber || '‚Äî'), dotClass: 'bg-gold' });
        });

        this.socket.on('reportes:plato-listo', (data) => {
          this.addActivity({ text: 'Plato listo ‚Äî Comanda #' + (data.comandaNumber || data.comandaId?.slice(-4) || '‚Äî') + (data.platoNombre ? ' (' + data.platoNombre + ')' : ''), dotClass: 'bg-st-preparado' });
        });

        this.socket.on('reportes:boucher-nuevo', (data) => {
          const monto = data.monto || data.total || 0;
          const mesaNum = data.mesaNum || data.mesa?.numMesa || '‚Äî';
          this.addActivity({ text: 'Pago procesado ‚Äî S/. ' + monto.toLocaleString('es-PE') + ' (Mesa ' + mesaNum + ')', dotClass: 'bg-st-pagado' });
          this.refreshVentasChart();
        });

        this.socket.on('plato-menu-actualizado', () => {});
        this.socket.on('socket-status', (data) => { console.log('Socket status:', data); });
        this.socket.on('connect_error', (err) => { console.warn('Socket.io no disponible:', err.message); });
        this.socket.on('connect', () => { console.log('Socket.io /admin conectado'); });
      } catch (e) { console.warn('Socket.io init error:', e); }
    },

    addActivity(item) {
      item.time = 'ahora';
      item.timestamp = Date.now();
      this.activity.unshift(item);
      if (this.activity.length > 6) this.activity.pop();
    },

    async refreshVentasChart() {
      const hoy = new Date().toISOString().split('T')[0];
      try {
        const reporteHoy = await apiGet('/reportes/ventas?fechaInicio=' + hoy + '&fechaFin=' + hoy + '&agruparPor=hora');
        if (reporteHoy && reporteHoy.data && reporteHoy.data.length > 0) {
          this._ventasDataCache = reporteHoy.data.map(d => d.total || 0);
          this._ventasLabelsCache = reporteHoy.data.map(d => d._id || d.hora || '');
          const totalHoy = reporteHoy.data.reduce((s, d) => s + (d.total || 0), 0);
          this.kpiVentasHoy = 'S/. ' + totalHoy.toLocaleString('es-PE');
          if (this.dashboardLayout.includes('grafico-ventas')) {
            LasGambusinasCharts.drawDashChartWithData('chartVentasDia', this._ventasLabelsCache, this._ventasDataCache);
          }
        } else {
          this.kpiVentasHoy = 'S/. 0';
          if (this.dashboardLayout.includes('grafico-ventas')) {
            LasGambusinasCharts.drawEmptyChart('chartVentasDia', 'Sin ventas registradas hoy');
          }
        }
      } catch (e) { console.warn('Error actualizando gr√°fico:', e); }
    },

    startAutoRefresh() {
      setInterval(() => { this.updateActivityTimes(); }, 60000);
      setInterval(() => { this.loadDashboard(); }, 30000);
    },

    updateActivityTimes() {
      this.activity = this.activity.map(a => {
        if (a.timestamp) a.time = this.timeAgo(new Date(a.timestamp));
        return a;
      });
    },

    timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 10) return 'ahora';
      if (seconds < 60) return 'hace ' + seconds + 's';
      if (seconds < 3600) return 'hace ' + Math.floor(seconds / 60) + ' min';
      if (seconds < 86400) return 'hace ' + Math.floor(seconds / 3600) + 'h';
      return 'hace ' + Math.floor(seconds / 86400) + ' d√≠as';
    },

    estadoNormalizado(estado) {
      const map = { 'libre':'Libre','ocupada':'Ocupada','pedido':'Pedido','preparado':'Preparado','pagado':'Pagado','reservado':'Reservado' };
      return map[estado?.toLowerCase()] || estado || 'Libre';
    },

    getSaludo() { const h = new Date().getHours(); return h < 12 ? 'd√≠as' : h < 19 ? 'tardes' : 'noches'; },
    getFecha() { return new Date().toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' }); },
    openMesa(m) { this.selectedMesa = m; this.modal = 'detalleMesa'; },

    async liberarMesa() {
      if (!this.selectedMesa?._id) return;
      const res = await apiPut('/mesas/' + this.selectedMesa._id, { estado: 'libre' });
      if (res && !res.error) { this.modal = null; await this.loadDashboard(); }
    },

    exportarDashboard() {
      const resumen = `LAS GAMBUSINAS - RESUMEN DEL D√çA\n================================\nFecha: ${this.getFecha()}\n\nMESAS\n- Ocupadas: ${this.kpiMesasOcupadas}\n- Ocupaci√≥n: ${this.kpiOcupacionPct}\n\nVENTAS\n- Total hoy: ${this.kpiVentasHoy}\n\nMOZOS\n- Top mozo: ${this.kpiTopMozo}\n\nGenerado: ${new Date().toLocaleString('es-PE')}`;
      const blob = new Blob([resumen], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'dashboard_' + new Date().toISOString().split('T')[0] + '.txt';
      link.click();
      URL.revokeObjectURL(link.href);
    },

    logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('gambusinas_auth');
      if (this.socket) this.socket.disconnect();
      window.location.href = '/login';
    }
  };
}

// ============================================
// APP: PERSONALIZAR DASHBOARD
// ============================================
function personalizarApp() {
  return {
    persTab: 'agregar',
    widgetSearch: '',
    catMetricas: true,
    catGraficos: true,
    catOperaciones: false,
    catAnalisis: false,
    dragIdx: null,
    overIdx: null,
    currentPresetName: '',
    activeWidgets: [],

    // Widget catalog arrays (for display in the "Agregar" tab)
    widgetsMetricas: Object.entries(WIDGET_CATALOG).filter(([,v]) => v.tipo === 'kpi').map(([id, v]) => ({ id, ...v })),
    widgetsGraficos: Object.entries(WIDGET_CATALOG).filter(([id, v]) => v.tipo === 'panel' && id.startsWith('grafico')).map(([id, v]) => ({ id, ...v })),
    widgetsOperaciones: Object.entries(WIDGET_CATALOG).filter(([id, v]) => (v.tipo === 'panel' || v.tipo === 'full') && !id.startsWith('grafico') && !id.startsWith('kpi')).map(([id, v]) => ({ id, ...v })),
    widgetsAnalisis: [
      { id: 'top-platos', ...WIDGET_CATALOG['top-platos'] },
      { id: 'clientes-frecuentes', ...WIDGET_CATALOG['clientes-frecuentes'] },
      { id: 'hora-pico', ...WIDGET_CATALOG['hora-pico'] },
      { id: 'comparativo', ...WIDGET_CATALOG['comparativo'] }
    ],
    layoutPresets: LAYOUT_PRESETS,

    init() {
      // Clone current layout from dashApp
      const dashEl = document.querySelector('[x-data="dashApp()"]');
      if (dashEl && dashEl.__x) {
        const layout = dashEl.__x.$data.dashboardLayout || DEFAULT_LAYOUT;
        this.activeWidgets = layout.map(id => ({ id, ...(WIDGET_CATALOG[id] || { icon: 'üì¶', nombre: id, tamano: '‚Äî' }) }));
      } else {
        // Fallback: read from storage
        try {
          const saved = localStorage.getItem('dashboardLayout');
          if (saved) {
            const parsed = JSON.parse(saved);
            const ids = parsed.widgets || parsed;
            const arr = (Array.isArray(ids) ? ids : DEFAULT_LAYOUT).map(w => typeof w === 'string' ? w : w.id);
            this.activeWidgets = arr.filter(id => WIDGET_CATALOG[id]).map(id => ({ id, ...WIDGET_CATALOG[id] }));
          } else {
            this.activeWidgets = DEFAULT_LAYOUT.map(id => ({ id, ...WIDGET_CATALOG[id] }));
          }
        } catch (e) {
          this.activeWidgets = DEFAULT_LAYOUT.map(id => ({ id, ...WIDGET_CATALOG[id] }));
        }
      }
      this.detectCurrentPreset();
    },

    // Search filter: expose filtered arrays as getters
    filteredWidgets(list) {
      if (!this.widgetSearch.trim()) return list;
      const q = this.widgetSearch.toLowerCase();
      return list.filter(w => w.nombre.toLowerCase().includes(q) || w.id.toLowerCase().includes(q));
    },

    isWidgetActive(id) { return this.activeWidgets.some(w => w.id === id); },

    addWidget(widget) {
      if (!this.isWidgetActive(widget.id)) {
        this.activeWidgets.push({ id: widget.id, ...(WIDGET_CATALOG[widget.id] || widget) });
        this.currentPresetName = '';
        this.showToast('Widget a√±adido: ' + widget.nombre);
      }
    },

    removeWidget(id) {
      this.activeWidgets = this.activeWidgets.filter(w => w.id !== id);
      this.currentPresetName = '';
      this.showToast('Widget eliminado');
    },

    // Drag & drop
    dragStart(e, idx) { this.dragIdx = idx; e.dataTransfer.effectAllowed = 'move'; },
    dragOver(e, idx) {
      if (this.dragIdx === null || this.dragIdx === idx) return;
      const items = [...this.activeWidgets];
      const [moved] = items.splice(this.dragIdx, 1);
      items.splice(idx, 0, moved);
      this.activeWidgets = items;
      this.dragIdx = idx;
    },
    dragEnd() { this.dragIdx = null; this.currentPresetName = ''; },

    // Button reorder
    moveWidget(idx, direction) {
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= this.activeWidgets.length) return;
      const items = [...this.activeWidgets];
      [items[idx], items[newIdx]] = [items[newIdx], items[idx]];
      this.activeWidgets = items;
      this.currentPresetName = '';
    },

    // Presets
    applyPreset(preset) {
      this.activeWidgets = preset.widgets.filter(id => WIDGET_CATALOG[id]).map(id => ({ id, ...WIDGET_CATALOG[id] }));
      this.currentPresetName = preset.name;
      this.showToast('Layout "' + preset.name + '" aplicado');
    },

    detectCurrentPreset() {
      const currentIds = this.activeWidgets.map(w => w.id).join(',');
      const match = LAYOUT_PRESETS.find(p => p.widgets.join(',') === currentIds);
      this.currentPresetName = match ? match.name : '';
    },

    restoreDefaults() {
      this.applyPreset(LAYOUT_PRESETS[0]);
    },

    async saveLayout() {
      const layoutIds = this.activeWidgets.map(w => w.id);

      // Dispatch to dashApp
      this.$el.closest('[x-data="dashApp()"]')?.dispatchEvent(
        new CustomEvent('layout-updated', { detail: { layout: layoutIds } })
      );

      // Try API, fallback localStorage
      const layoutData = { widgets: layoutIds, savedAt: new Date().toISOString() };
      try {
        const res = await apiPost('/dashboard/layout', layoutData);
        if (res && !res.error) {
          this.showToast('Layout guardado en servidor');
        } else {
          localStorage.setItem('dashboardLayout', JSON.stringify(layoutData));
          this.showToast('Layout guardado localmente');
        }
      } catch (e) {
        localStorage.setItem('dashboardLayout', JSON.stringify(layoutData));
        this.showToast('Layout guardado localmente');
      }

      // Close modal
      const dashData = this.$el.closest('[x-data="dashApp()"]');
      if (dashData && dashData.__x) dashData.__x.$data.modal = null;
    },

    showToast(msg) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const t = document.createElement('div');
      t.className = 'px-4 py-3 rounded-xl text-sm font-medium shadow-xl bg-st-preparado text-white animate-[fadeIn_0.2s]';
      t.textContent = msg;
      container.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2500);
    }
  };
}
</script>
<!-- Page Transitions JS -->
<script src="/assets/js/page-transitions.js"></script>
</body>
</html>
